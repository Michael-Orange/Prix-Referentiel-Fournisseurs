# BRIEF : Authentification avec Table Users + Secrets Replit

## ğŸ¯ OBJECTIF
Authentification par email/mot de passe en utilisant :
- **Table `users`** existante en BDD pour les infos utilisateur (nom, email, role)
- **Secrets Replit** pour les mots de passe (simplicitÃ©, sÃ©curitÃ©)

## ğŸ‘¥ UTILISATEURS INITIAUX

3 utilisateurs Ã  crÃ©er dans la table `users` :

| Nom | Email | RÃ´le | Mot de passe (Secret) |
|-----|-------|------|-----------------------|
| Marine | marine@filtreplante.com | admin | Fplante1! |
| Fatou | fatou@filtreplante.com | utilisateur | Fplante1! |
| Michael | michael@filtreplante.com | admin | Fatou1! |

## ğŸ“Š SCHEMA BASE DE DONNÃ‰ES

### VÃ©rifier/Adapter la table `users` existante

**Structure requise :**
```typescript
export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  nom: text("nom").notNull(), // "Marine", "Fatou", "Michael"
  email: text("email").notNull().unique(),
  role: text("role").notNull().default("utilisateur"), // "admin" | "utilisateur"
  actif: boolean("actif").notNull().default(true),
  derniereConnexion: timestamp("derniere_connexion"),
  dateCreation: timestamp("date_creation").notNull().defaultNow(),
});
```

**Si la table existe dÃ©jÃ  (GestionStockFP), vÃ©rifier qu'elle a ces colonnes.**

Si `derniere_connexion` manque :
```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS derniere_connexion TIMESTAMP;
```

## ğŸ” CONFIGURATION SECRETS REPLIT

### 1. SESSION_SECRET

```
SESSION_SECRET=<gÃ©nÃ©rer-via-crypto.randomBytes(32).toString('hex')>
```

Pour gÃ©nÃ©rer :
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 2. AUTH_PASSWORDS (nouveau format)

**Format** : `email:password,email:password,...`

```
AUTH_PASSWORDS=marine@filtreplante.com:Fplante1!,fatou@filtreplante.com:Fplante1!,michael@filtreplante.com:Fatou1!
```

**Pourquoi ce format :**
- SÃ©curisÃ© (mots de passe dans Secrets, chiffrÃ©s)
- Simple (pas de bcrypt)
- Les infos utilisateur (nom, role) sont en BDD
- Facile de changer un mot de passe (modifier Secret)

## ğŸ› ï¸ IMPLÃ‰MENTATION BACKEND

### 1. Installer dÃ©pendances

```bash
npm install express-session
npm install --save-dev @types/express-session
```

### 2. Script d'initialisation des users

CrÃ©er `scripts/init-users.ts` :
```typescript
import { db } from '../server/db';
import { users } from '../shared/schema';
import { eq } from 'drizzle-orm';

const INITIAL_USERS = [
  { nom: 'Marine', email: 'marine@filtreplante.com', role: 'admin' },
  { nom: 'Fatou', email: 'fatou@filtreplante.com', role: 'utilisateur' },
  { nom: 'Michael', email: 'michael@filtreplante.com', role: 'admin' },
];

async function initUsers() {
  console.log('ğŸ‘¥ Initialisation des utilisateurs...');
  
  for (const userData of INITIAL_USERS) {
    try {
      // VÃ©rifier si user existe dÃ©jÃ 
      const existing = await db
        .select()
        .from(users)
        .where(eq(users.email, userData.email))
        .limit(1);
      
      if (existing.length > 0) {
        console.log(`âœ… ${userData.nom} existe dÃ©jÃ `);
      } else {
        // CrÃ©er le user
        await db.insert(users).values({
          nom: userData.nom,
          email: userData.email,
          role: userData.role,
          actif: true,
        });
        console.log(`âœ… ${userData.nom} crÃ©Ã©`);
      }
    } catch (error) {
      console.error(`âŒ Erreur pour ${userData.nom}:`, error);
    }
  }
  
  console.log('ğŸ‰ Initialisation terminÃ©e');
}

initUsers();
```

ExÃ©cuter : `tsx scripts/init-users.ts`

### 3. Parser les mots de passe depuis Secrets

CrÃ©er `server/auth/passwords.ts` :
```typescript
// Parser AUTH_PASSWORDS depuis Secrets
function parsePasswordsFromEnv(): Map<string, string> {
  const authPasswords = process.env.AUTH_PASSWORDS || '';
  const passwordMap = new Map<string, string>();
  
  if (!authPasswords) {
    console.warn('âš ï¸ AUTH_PASSWORDS non dÃ©fini dans Secrets');
    return passwordMap;
  }
  
  authPasswords.split(',').forEach((entry) => {
    const [email, password] = entry.split(':');
    if (email && password) {
      passwordMap.set(email.trim().toLowerCase(), password.trim());
    }
  });
  
  return passwordMap;
}

export const PASSWORDS = parsePasswordsFromEnv();

// Helper : vÃ©rifier mot de passe
export function verifyPassword(email: string, password: string): boolean {
  const storedPassword = PASSWORDS.get(email.toLowerCase());
  return storedPassword === password;
}
```

### 4. Configuration express-session

Dans `server/index.ts` :
```typescript
import session from 'express-session';

app.use(
  session({
    secret: process.env.SESSION_SECRET || 'change-me-in-production',
    resave: false,
    saveUninitialized: false,
    cookie: {
      maxAge: 30 * 24 * 60 * 60 * 1000, // 30 jours
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
    },
  })
);

// Typage TypeScript
declare module 'express-session' {
  interface SessionData {
    userId: number;
    userEmail: string;
    userName: string;
    userRole: string;
  }
}
```

### 5. Routes d'authentification

CrÃ©er `server/routes/auth.ts` :
```typescript
import { Router } from 'express';
import { db } from '../db';
import { users } from '../../shared/schema';
import { eq, and } from 'drizzle-orm';
import { verifyPassword } from '../auth/passwords';

const router = Router();

// POST /api/auth/login
router.post('/login', async (req, res) => {
  const { email, password } = req.body;
  
  if (!email || !password) {
    return res.status(400).json({ error: 'Email et mot de passe requis' });
  }
  
  try {
    // 1. RÃ©cupÃ©rer user depuis BDD
    const [user] = await db
      .select()
      .from(users)
      .where(
        and(
          eq(users.email, email.toLowerCase()),
          eq(users.actif, true)
        )
      )
      .limit(1);
    
    if (!user) {
      return res.status(401).json({ error: 'Email ou mot de passe incorrect' });
    }
    
    // 2. VÃ©rifier mot de passe depuis Secrets
    if (!verifyPassword(email, password)) {
      return res.status(401).json({ error: 'Email ou mot de passe incorrect' });
    }
    
    // 3. Mettre Ã  jour derniÃ¨re connexion
    await db
      .update(users)
      .set({ derniereConnexion: new Date() })
      .where(eq(users.id, user.id));
    
    // 4. CrÃ©er session
    req.session.userId = user.id;
    req.session.userEmail = user.email;
    req.session.userName = user.nom; // "Marine", "Fatou", "Michael"
    req.session.userRole = user.role;
    
    res.json({
      id: user.id,
      nom: user.nom,
      email: user.email,
      role: user.role,
    });
  } catch (error) {
    console.error('Erreur login:', error);
    res.status(500).json({ error: 'Erreur serveur' });
  }
});

// POST /api/auth/logout
router.post('/logout', (req, res) => {
  req.session.destroy((err) => {
    if (err) {
      return res.status(500).json({ error: 'Erreur logout' });
    }
    res.clearCookie('connect.sid');
    res.json({ message: 'DÃ©connectÃ©' });
  });
});

// GET /api/auth/me
router.get('/me', async (req, res) => {
  if (!req.session.userId) {
    return res.status(401).json({ error: 'Non authentifiÃ©' });
  }
  
  try {
    const [user] = await db
      .select({
        id: users.id,
        nom: users.nom,
        email: users.email,
        role: users.role,
      })
      .from(users)
      .where(
        and(
          eq(users.id, req.session.userId),
          eq(users.actif, true)
        )
      )
      .limit(1);
    
    if (!user) {
      req.session.destroy(() => {});
      return res.status(401).json({ error: 'Utilisateur introuvable' });
    }
    
    res.json(user);
  } catch (error) {
    console.error('Erreur /me:', error);
    res.status(500).json({ error: 'Erreur serveur' });
  }
});

export default router;
```

Importer dans `server/index.ts` :
```typescript
import authRoutes from './routes/auth';
app.use('/api/auth', authRoutes);
```

### 6. Middleware de protection

CrÃ©er `server/middleware/requireAuth.ts` + `attachUser.ts` (identique au brief prÃ©cÃ©dent).

### 7. Audit trail : Middleware attachUser

CrÃ©er `server/middleware/attachUser.ts` :
```typescript
import { Request, Response, NextFunction } from 'express';

declare global {
  namespace Express {
    interface Request {
      user?: {
        id: number;
        nom: string;
        email: string;
        role: string;
      };
    }
  }
}

export function attachUser(req: Request, res: Response, next: NextFunction) {
  if (req.session.userId && req.session.userName) {
    req.user = {
      id: req.session.userId,
      nom: req.session.userName, // "Marine", "Fatou", "Michael"
      email: req.session.userEmail,
      role: req.session.userRole,
    };
  }
  next();
}
```

Appliquer dans `server/index.ts` :
```typescript
import { attachUser } from './middleware/attachUser';

app.use(session({ ... }));
app.use(attachUser); // APRÃˆS session, AVANT routes
```

## ğŸ¨ FRONTEND (identique au brief prÃ©cÃ©dent)

Page login, ProtectedRoute, LogoutButton â†’ mÃªme code que brief prÃ©cÃ©dent.

## ğŸ“ AUDIT TRAIL (Tracking "crÃ©Ã© par / modifiÃ© par")

### Utiliser req.user.nom dans les routes

**Exemples :**

#### CrÃ©ation produit
```typescript
app.post('/api/referentiel/produits', requireAuth, async (req, res) => {
  const { nom, categorie, unite, ... } = req.body;
  
  const [produit] = await db.insert(produitsMaster).values({
    nom,
    categorie,
    unite,
    creePar: req.user?.nom || 'SystÃ¨me', // â† "Marine", "Fatou", "Michael"
    actif: true,
  }).returning();
  
  res.status(201).json(produit);
});
```

#### Modification produit
```typescript
app.patch('/api/referentiel/produits/:id', requireAuth, async (req, res) => {
  const { id } = req.params;
  const updates = req.body;
  
  // Ajouter colonne modifie_par si nÃ©cessaire
  const [produit] = await db
    .update(produitsMaster)
    .set({
      ...updates,
      dateModification: new Date(),
      // Optionnel : modifiePar: req.user?.nom
    })
    .where(eq(produitsMaster.id, parseInt(id)))
    .returning();
  
  res.json(produit);
});
```

#### CrÃ©ation prix
```typescript
app.post('/api/prix/produits/:id/fournisseurs', requireAuth, async (req, res) => {
  const { produitId } = req.params;
  const { fournisseurId, prixHt, regimeFiscal } = req.body;
  
  const [prix] = await db.insert(prixFournisseurs).values({
    produitMasterId: parseInt(produitId),
    fournisseurId,
    prixHt,
    regimeFiscal,
    creePar: req.user?.nom || 'SystÃ¨me', // â† ICI
    actif: true,
  }).returning();
  
  res.status(201).json(prix);
});
```

#### Mouvements stock (prendre/rendre)
```typescript
app.post('/api/movements', requireAuth, async (req, res) => {
  const { produitId, quantite, type, ... } = req.body;
  
  const [movement] = await db.insert(movements).values({
    produitId,
    quantite,
    type,
    utilisateurId: req.user?.id, // â† ID user depuis session
    // OU creePar: req.user?.nom si colonne existe
  }).returning();
  
  res.json(movement);
});
```

## ğŸ”„ AJOUTER UN NOUVEAU USER

**Super simple maintenant !**

### Ã‰tape 1 : Ajouter dans la BDD
```sql
INSERT INTO users (nom, email, role, actif)
VALUES ('Sophie', 'sophie@filtreplante.com', 'utilisateur', true);
```

### Ã‰tape 2 : Ajouter le mot de passe dans Secrets
```
# AVANT
AUTH_PASSWORDS=marine@filtreplante.com:Fplante1!,fatou@filtreplante.com:Fplante1!,michael@filtreplante.com:Fatou1!

# APRÃˆS
AUTH_PASSWORDS=marine@filtreplante.com:Fplante1!,fatou@filtreplante.com:Fplante1!,michael@filtreplante.com:Fatou1!,sophie@filtreplante.com:SophieMdp123!
```

### Ã‰tape 3 : RedÃ©marrer le Repl

**C'est tout ! 2 minutes.** ğŸš€

## ğŸ“Š AFFICHAGE AUDIT (tu dÃ©cides)

### Colonnes Ã  ajouter dans UI

**Liste produits :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Produit         â”‚ CatÃ©gorieâ”‚ CrÃ©Ã© par  â”‚ Date         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tuyau PVC DN63  â”‚ Plomberieâ”‚ Marine    â”‚ 12/01/2026   â”‚
â”‚ Bouteille dilua â”‚ ClotÃ»re  â”‚ Fatou     â”‚ 15/01/2026   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DÃ©tail produit :**
```
Informations produit
--------------------
Nom : Tuyau PVC DN63
CatÃ©gorie : Plomberie-Tuyauterie
UnitÃ© : mÃ¨tre(s)

ğŸ“ Audit
CrÃ©Ã© par Marine le 12/01/2026
DerniÃ¨re modification : 18/02/2026
```

**Historique prix :**
```
ğŸ“… 20/02/2026 14:30
   Prix HT : 4 500 â†’ 5 000 FCFA
   Par Marine

ğŸ“… 15/01/2026 10:15
   Prix HT : 4 000 â†’ 4 500 FCFA
   Par Michael
```

**Mouvements stock :**
```
ğŸ“¦ PrÃªt de 5 unitÃ©s
   Produit : Tuyau PVC DN63
   Par Fatou
   Le 18/02/2026
```

## âœ… CHECKLIST DE VALIDATION

**Backend :**
- [ ] Table `users` contient les 3 users (Marine, Fatou, Michael)
- [ ] `AUTH_PASSWORDS` dÃ©fini dans Secrets
- [ ] Login avec marine@filtreplante.com / Fplante1! â†’ OK
- [ ] `req.user.nom` contient "Marine" aprÃ¨s login
- [ ] CrÃ©ation produit enregistre `creePar = "Marine"`
- [ ] CrÃ©ation prix enregistre `creePar = "Fatou"`
- [ ] Modification produit met Ã  jour `dateModification`

**Frontend :**
- [ ] Page login fonctionne
- [ ] Liste produits affiche colonne "CrÃ©Ã© par"
- [ ] DÃ©tail produit affiche section Audit
- [ ] Historique prix affiche "Par X"

**Tests :**
- [ ] Login avec les 3 comptes â†’ OK
- [ ] CrÃ©er produit avec Marine â†’ `creePar = "Marine"` en BDD
- [ ] Modifier prix avec Michael â†’ historique montre "Par Michael"
- [ ] Ajouter nouveau user Sophie â†’ fonctionne aprÃ¨s redÃ©marrage

## ğŸ¯ RÃ‰SUMÃ‰ : Pourquoi c'est mieux

| Avant (parser email) | **AprÃ¨s (Table users + Secrets)** |
|---------------------|----------------------------------|
| PrÃ©nom = parser email (fragile) | âœ… PrÃ©nom stockÃ© en BDD (`nom`) |
| Ajouter user = modifier code | âœ… Ajouter user = INSERT + modifier Secret |
| Pas d'audit connexion | âœ… `derniere_connexion` trackÃ©e |
| Pas cohÃ©rent avec Stock | âœ… RÃ©utilise table existante |