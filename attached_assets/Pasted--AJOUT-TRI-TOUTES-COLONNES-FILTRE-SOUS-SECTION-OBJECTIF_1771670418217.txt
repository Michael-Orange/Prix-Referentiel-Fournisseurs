# AJOUT : TRI TOUTES COLONNES + FILTRE SOUS-SECTION

## OBJECTIF
1. Rendre TOUTES les colonnes triables (pas seulement certaines)
2. Ajouter filtre Sous-section dans la barre de filtres (actif uniquement si cat√©gorie s√©lectionn√©e)

# PARTIE 1 : TRI SUR TOUTES LES COLONNES

File: client/src/pages/produits.tsx

## 1. Ajouter cl√©s de tri manquantes dans sortConfig

Actuellement, certaines colonnes ne sont pas triables. Ajouter support pour :
- `stockage` (estStockable)
- `sousSection`
- `unite`
- `fournisseur` (nom fournisseur d√©faut)
- `regimeFiscal`

V√©rifier que `sortConfig` accepte toutes ces cl√©s :

```typescript
const [sortConfig, setSortConfig] = useState<{
  key: 'nom' | 'categorie' | 'stockage' | 'sousSection' | 'unite' | 'fournisseur' | 'prixHT' | 'regimeFiscal' | 'derniereMAJ' | 'creePar';
  direction: 'asc' | 'desc';
}>({
  key: 'nom',
  direction: 'asc',
});
2. Mettre √† jour la fonction de tri dans useMemo
Dans le useMemo qui calcule sortedProduits, ajouter les cases manquants :
const sortedProduits = useMemo(() => {
  let sorted = [...filteredProduits];
  
  sorted.sort((a, b) => {
    let aVal: any;
    let bVal: any;
    
    switch (sortConfig.key) {
      case 'nom':
        aVal = a.nom.toLowerCase();
        bVal = b.nom.toLowerCase();
        break;
      case 'categorie':
        aVal = a.categorie.toLowerCase();
        bVal = b.categorie.toLowerCase();
        break;
      case 'stockage':  // ‚Üê AJOUTER
        aVal = a.estStockable ? 1 : 0;
        bVal = b.estStockable ? 1 : 0;
        break;
      case 'sousSection':  // ‚Üê AJOUTER
        aVal = (a.sousSection || 'Tous').toLowerCase();
        bVal = (b.sousSection || 'Tous').toLowerCase();
        break;
      case 'unite':  // ‚Üê AJOUTER
        aVal = a.unite.toLowerCase();
        bVal = b.unite.toLowerCase();
        break;
      case 'fournisseur':  // ‚Üê AJOUTER
        aVal = a.fournisseurDefaut?.nom.toLowerCase() || '';
        bVal = b.fournisseurDefaut?.nom.toLowerCase() || '';
        break;
      case 'prixHT':
        aVal = a.fournisseurDefaut?.prixHt || 0;
        bVal = b.fournisseurDefaut?.prixHt || 0;
        break;
      case 'regimeFiscal':
        aVal = a.fournisseurDefaut?.regimeFiscal || '';
        bVal = b.fournisseurDefaut?.regimeFiscal || '';
        break;
      case 'derniereMAJ':
        aVal = a.prixDateModification ? new Date(a.prixDateModification).getTime() : 0;
        bVal = b.prixDateModification ? new Date(b.prixDateModification).getTime() : 0;
        break;
      case 'creePar':
        aVal = a.creePar?.toLowerCase() || '';
        bVal = b.creePar?.toLowerCase() || '';
        break;
      default:
        return 0;
    }
    
    if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
    return 0;
  });
  
  return sorted;
}, [filteredProduits, sortConfig]);
3. Ajouter en-t√™te triable sur colonnes manquantes
Colonne Stockage
REMPLACER :
{
  key: "stockage",
  header: "Stockage",
  render: ...
}
PAR :
{
  key: "stockage",
  header: (
    <div className="flex items-center gap-1 cursor-pointer select-none" onClick={() => handleSort('stockage')}>
      <span>Stockage</span>
      <SortIcon columnKey="stockage" />
    </div>
  ),
  render: ...
}
Colonne Sous-section
REMPLACER :
{
  key: "sousSection",
  header: "Sous-section",
  render: ...
}
PAR :
{
  key: "sousSection",
  header: (
    <div className="flex items-center gap-1 cursor-pointer select-none" onClick={() => handleSort('sousSection')}>
      <span>Sous-section</span>
      <SortIcon columnKey="sousSection" />
    </div>
  ),
  render: ...
}
Colonne Unit√©
REMPLACER :
{
  key: "unite",
  header: "Unit√©",
  render: ...
}
PAR :
{
  key: "unite",
  header: (
    <div className="flex items-center gap-1 cursor-pointer select-none" onClick={() => handleSort('unite')}>
      <span>Unit√©</span>
      <SortIcon columnKey="unite" />
    </div>
  ),
  render: ...
}
Colonne Fournisseur d√©faut
REMPLACER :
{
  key: "fournisseur",
  header: "Fournisseur d√©faut",
  render: ...
}
PAR :
{
  key: "fournisseur",
  header: (
    <div className="flex items-center gap-1 cursor-pointer select-none" onClick={() => handleSort('fournisseur')}>
      <span>Fournisseur d√©faut</span>
      <SortIcon columnKey="fournisseur" />
    </div>
  ),
  render: ...
}
PARTIE 2 : FILTRE SOUS-SECTION DANS LA BARRE
File: client/src/pages/produits.tsx
1. Ajouter √©tat filtre sous-section
Apr√®s les √©tats de filtres existants, ajouter :
const [selectedSousSection, setSelectedSousSection] = useState<string>("Tous");
2. R√©cup√©rer les sous-sections de la cat√©gorie s√©lectionn√©e
Cr√©er un computed pour les sous-sections disponibles :
const availableSousSections = useMemo(() => {
  if (!selectedCategorie || selectedCategorie === "Toutes cat√©gories") {
    return [];
  }
  
  // Filtrer les sous-sections de la cat√©gorie s√©lectionn√©e
  const ssSections = sousSections.filter((ss: any) => ss.categorie === selectedCategorie);
  return ssSections;
}, [selectedCategorie, sousSections]);
3. R√©initialiser filtre sous-section quand cat√©gorie change
Ajouter un useEffect :
useEffect(() => {
  // Quand la cat√©gorie change, reset le filtre sous-section
  if (!selectedCategorie || selectedCategorie === "Toutes cat√©gories") {
    setSelectedSousSection("Tous");
  }
}, [selectedCategorie]);
4. Appliquer filtre sous-section dans filteredProduits
Dans le useMemo qui calcule filteredProduits, ajouter condition :
const filteredProduits = useMemo(() => {
  let filtered = produits;
  
  // Filtre par recherche
  if (searchQuery) {
    filtered = filtered.filter(p => 
      p.nom.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }
  
  // Filtre par cat√©gorie
  if (selectedCategorie && selectedCategorie !== "Toutes cat√©gories") {
    filtered = filtered.filter(p => p.categorie === selectedCategorie);
  }
  
  // ‚Üê AJOUTER CE FILTRE
  // Filtre par sous-section
  if (selectedSousSection && selectedSousSection !== "Tous") {
    filtered = filtered.filter(p => p.sousSection === selectedSousSection);
  }
  
  // Filtre par prix (avec/sans)
  if (selectedPrixFilter === "avec") {
    filtered = filtered.filter(p => p.fournisseurDefaut);
  } else if (selectedPrixFilter === "sans") {
    filtered = filtered.filter(p => !p.fournisseurDefaut);
  }
  
  // Filtre stockable
  if (selectedStockable !== "tous") {
    const isStockable = selectedStockable === "stockable";
    filtered = filtered.filter(p => p.estStockable === isStockable);
  }
  
  // Filtre actifs/inactifs
  if (!showInactifs) {
    filtered = filtered.filter(p => p.actif);
  }
  
  return filtered;
}, [produits, searchQuery, selectedCategorie, selectedSousSection, selectedPrixFilter, selectedStockable, showInactifs]);
5. Ajouter le Select Sous-section dans la barre de filtres
Localiser la barre de filtres (ligne avec les Selects), et INS√âRER le filtre Sous-section APR√àS le filtre Cat√©gorie :
<div className="flex gap-2 items-center">
  {/* Filtre Cat√©gorie */}
  <Select value={selectedCategorie} onValueChange={setSelectedCategorie}>
    <SelectTrigger className="w-[200px]">
      <SelectValue placeholder="Toutes cat√©gories" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="Toutes cat√©gories">Toutes cat√©gories</SelectItem>
      {categories.map((cat: any) => (
        <SelectItem key={cat.id} value={cat.nom}>{cat.nom}</SelectItem>
      ))}
    </SelectContent>
  </Select>
  
  {/* ‚Üê AJOUTER CE FILTRE */}
  {/* Filtre Sous-section (actif seulement si cat√©gorie s√©lectionn√©e) */}
  <Select 
    value={selectedSousSection} 
    onValueChange={setSelectedSousSection}
    disabled={!selectedCategorie || selectedCategorie === "Toutes cat√©gories"}
  >
    <SelectTrigger className="w-[200px]">
      <SelectValue placeholder="Tous" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="Tous">Tous</SelectItem>
      {availableSousSections.map((ss: any) => (
        <SelectItem key={ss.id} value={ss.nom}>{ss.nom}</SelectItem>
      ))}
    </SelectContent>
  </Select>
  
  {/* ... Autres filtres (Prix, Stockable, Inactifs) ... */}
</div>
6. Feedback visuel quand d√©sactiv√©
Le filtre Sous-section appara√Æt gris√© quand aucune cat√©gorie n'est s√©lectionn√©e :
<SelectTrigger 
  className={`w-[200px] ${
    (!selectedCategorie || selectedCategorie === "Toutes cat√©gories") 
      ? 'opacity-50 cursor-not-allowed' 
      : ''
  }`}
>
Optionnel : Ajouter tooltip explicatif :
<div className="relative">
  <Select 
    value={selectedSousSection} 
    onValueChange={setSelectedSousSection}
    disabled={!selectedCategorie || selectedCategorie === "Toutes cat√©gories"}
  >
    <SelectTrigger className="w-[200px]">
      <SelectValue placeholder="Tous" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="Tous">Tous</SelectItem>
      {availableSousSections.map((ss: any) => (
        <SelectItem key={ss.id} value={ss.nom}>{ss.nom}</SelectItem>
      ))}
    </SelectContent>
  </Select>
  
  {(!selectedCategorie || selectedCategorie === "Toutes cat√©gories") && (
    <div className="absolute -bottom-6 left-0 text-xs text-muted-foreground italic">
      S√©lectionnez une cat√©gorie d'abord
    </div>
  )}
</div>
ORDRE FINAL DES FILTRES
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [üîç Rechercher un produit...]                                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [Toutes cat√©gories ‚ñº] [Tous ‚ñº] [Tous les statuts ‚ñº] ‚òê Afficher inactifs ‚îÇ
‚îÇ                       ‚Üë D√©sactiv√© si cat√©gorie = "Toutes"                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
COMPORTEMENT
Sc√©nario 1 : Aucune cat√©gorie s√©lectionn√©e
Cat√©gorie: "Toutes cat√©gories"
Sous-section: D√©sactiv√© (gris√©)
R√©sultat: Tous les produits affich√©s
Sc√©nario 2 : Cat√©gorie s√©lectionn√©e sans sous-section
Cat√©gorie: "Plomberie"
Sous-section: "Tous" (activ√©, avec liste des sous-sections de Plomberie)
R√©sultat: Tous les produits de Plomberie affich√©s
Sc√©nario 3 : Cat√©gorie + Sous-section
Cat√©gorie: "Plomberie"
Sous-section: "Tubes PVC"
R√©sultat: Seulement les produits Plomberie > Tubes PVC affich√©s
Sc√©nario 4 : Retour √† "Toutes cat√©gories"
Cat√©gorie: "Toutes cat√©gories" (chang√©)
‚Üí useEffect r√©initialise automatiquement Sous-section √† "Tous"
‚Üí Filtre Sous-section d√©sactiv√©
TESTS √Ä EFFECTUER
Tri
 Clic sur "Stockage" ‚Üí Tri Stockable puis Non stockable (ou inverse)
 Clic sur "Sous-section" ‚Üí Tri alphab√©tique A‚ÜíZ puis Z‚ÜíA
 Clic sur "Unit√©" ‚Üí Tri alphab√©tique des unit√©s
 Clic sur "Fournisseur d√©faut" ‚Üí Tri alphab√©tique des noms fournisseurs
 Clic sur "R√©gime fiscal" ‚Üí Tri BRS/Sans TVA/TVA 18%
 Toutes les colonnes affichent ic√¥ne tri (‚Üë ou ‚Üì) selon direction
 Double-clic sur m√™me colonne ‚Üí Inverse le tri
Filtre Sous-section
 Au chargement : Filtre sous-section d√©sactiv√© (cat√©gorie = "Toutes")
 S√©lectionner cat√©gorie ‚Üí Filtre sous-section activ√©
 Liste sous-section affiche uniquement celles de la cat√©gorie s√©lectionn√©e
 S√©lectionner sous-section ‚Üí Produits filtr√©s correctement
 Retour √† "Toutes cat√©gories" ‚Üí Sous-section r√©initialis√©e √† "Tous"
 Cat√©gorie sans sous-sections ‚Üí Seule option "Tous" dans le dropdown
Combinaison filtres
 Cat√©gorie + Sous-section + Recherche ‚Üí Filtres cumulatifs
 Cat√©gorie + Sous-section + Prix (avec/sans) ‚Üí OK
 Cat√©gorie + Sous-section + Tri ‚Üí OK
POINTS D'ATTENTION
‚ö†Ô∏è Le tri sur "Stockage" compare bool√©ens (true > false)
‚ö†Ô∏è Le tri sur "Sous-section" traite NULL/vide comme "Tous" (en premier ou dernier selon direction)
‚ö†Ô∏è Le filtre Sous-section est STRICTEMENT li√© √† la cat√©gorie (query d√©pend de selectedCategorie)
‚ö†Ô∏è R√©initialiser Sous-section quand cat√©gorie change (√©vite √©tats incoh√©rents)
‚ö†Ô∏è Si cat√©gorie n'a aucune sous-section, dropdown affiche seulement "Tous"
‚ö†Ô∏è Le disabled sur Select doit aussi griser visuellement (opacity-50)

---

## ‚úÖ R√âSUM√â

### **1. Tri universel**
Toutes les colonnes deviennent triables :
- Stockage (Stockable/Non)
- Sous-section (Alphab√©tique)
- Unit√© (Alphab√©tique)
- Fournisseur (Alphab√©tique)
- R√©gime fiscal (BRS/Sans/TVA)

### **2. Filtre Sous-section intelligent**
- D√©sactiv√© par d√©faut (cat√©gorie = "Toutes")
- S'active quand cat√©gorie s√©lectionn√©e
- Affiche uniquement sous-sections de cette cat√©gorie
- Se r√©initialise automatiquement si cat√©gorie change

### **3. UX am√©lior√©e**
- Feedback visuel (gris√© quand d√©sactiv√©)
- Ic√¥nes de tri sur tous les en-t√™tes
- Filtres combinables

**Pr√™t √† coder 