# BRIEF : R√©f√©rentiel Produits Filtreplante avec Prix Multi-Fournisseurs

## üéØ OBJECTIF
Cr√©er un r√©f√©rentiel centralis√© de tous les produits Filtreplante (stock√©s ou non) avec :
- D√©tection intelligente des doublons
- Gestion multi-fournisseurs par produit
- Calculs automatiques prix TTC/BRS selon r√©gime fiscal s√©n√©galais
- Historique des modifications de prix
- Fournisseur par d√©faut par produit

## üìê CONTEXTE ARCHITECTURAL

### Structure globale
- **Base de donn√©es unique** PostgreSQL partag√©e entre apps
- **3 schemas isol√©s** : 
  - `referentiel` : Donn√©es communes (produits, cat√©gories, unit√©s)
  - `stock` : Donn√©es sp√©cifiques √† la gestion de stock
  - `prix` : Donn√©es sp√©cifiques aux prix fournisseurs
- **R√®gle d'isolation** : Chaque app ne touche QUE ses schemas + referentiel (jamais les autres)

### Responsabilit√©s
- **App FP-Referentiel-Produit** (anciennement Prix) :
  - Propri√©taire des schemas `referentiel` + `prix`
  - G√®re les produits + fournisseurs + prix
  - Expose l'API REST avec authentification par scopes

- **App GestionStockFP** :
  - Lit/√©crit dans `referentiel.produits_master` (direct BDD)
  - G√®re `stock.*` (stock_actuel, mouvements, etc.)
  - Lit le fournisseur par d√©faut via API (d√©veloppement ult√©rieur)

## üóÇÔ∏è SCHEMA BASE DE DONN√âES

### 1. Schema "referentiel" (NOUVEAU)

#### Table : produits_master
R√©f√©rentiel unique de tous les produits Filtreplante (SANS les prix).

Colonnes :
- `id` : SERIAL PRIMARY KEY
- `nom` : TEXT NOT NULL UNIQUE (ex: "Tuyau PVC PN10 DN63")
- `nom_normalise` : TEXT NOT NULL (ex: "50mm pvc tuyau", pour recherche intelligente)
- `categorie` : TEXT NOT NULL (ex: "Plomberie-Tuyauterie", format avec tiret √† conserver)
- `sous_section` : TEXT (nullable, ex: "Accessoires")
- `unite` : TEXT NOT NULL (ex: "m√®tre(s)", "unit√©(s)", format long √† conserver)

**M√©tadonn√©es :**
- `est_stockable` : BOOLEAN NOT NULL DEFAULT false (true si g√©r√© dans Stock)
- `source_app` : TEXT NOT NULL ("stock" | "prix")
- `actif` : BOOLEAN NOT NULL DEFAULT true

**Attributs optionnels (pour g√©omembranes) :**
- `longueur` : REAL (nullable)
- `largeur` : REAL (nullable)
- `couleur` : TEXT (nullable)
- `est_template` : BOOLEAN DEFAULT false

**Audit :**
- `date_creation` : TIMESTAMP NOT NULL DEFAULT NOW()
- `date_modification` : TIMESTAMP NOT NULL DEFAULT NOW()
- `cree_par` : TEXT (username)

**Index :**
- UNIQUE sur `nom` (emp√™cher doublons exacts)
- GIN index sur `nom_normalise` (recherche trigrams PostgreSQL)
- Index sur `categorie`, `est_stockable`, `actif`

#### Table : categories
Liste fixe des cat√©gories Filtreplante.

Colonnes :
- `id` : SERIAL PRIMARY KEY
- `nom` : TEXT UNIQUE NOT NULL (ex: "Plomberie-Tuyauterie")
- `ordre_affichage` : INTEGER

**Peupler depuis le CSV Stock** (cat√©gories uniques extraites de la colonne "categorie")

#### Table : unites
Liste fixe des unit√©s de mesure.

Colonnes :
- `id` : SERIAL PRIMARY KEY
- `code` : TEXT UNIQUE NOT NULL (ex: "m", "u", "kg")
- `libelle` : TEXT NOT NULL (ex: "m√®tre(s)", "unit√©(s)")
- `type` : TEXT (ex: "longueur", "quantit√©", "masse")

**Peupler avec les unit√©s du CSV Stock** + ajouter les standards :
- unit√©(s) / u / quantit√©
- m√®tre(s) / m / longueur
- m√®tre lin√©aire(s) / ml / longueur
- m√®tre carr√©(s) / m¬≤ / surface
- kilogramme(s) / kg / masse
- litre(s) / l / volume
- tonne(s) / t / masse

### 2. Schema "prix" (ENRICHIR L'EXISTANT)

#### Table : fournisseurs (existante, √† conserver)
Liste des fournisseurs Filtreplante.

Structure actuelle √† garder :
- `id`, `nom`, `contact`, `telephone`, `email`, `adresse`
- `statut_tva` (√† utiliser comme d√©faut lors de cr√©ation prix)
- `actif`, `date_creation`, etc.

#### Table : prix_fournisseurs (√† enrichir/recr√©er)
Association produit ‚Üî fournisseur avec prix et r√©gime fiscal.

Colonnes :
- `id` : SERIAL PRIMARY KEY

**Relations :**
- `produit_master_id` : INTEGER REFERENCES referentiel.produits_master(id) NOT NULL
- `fournisseur_id` : INTEGER REFERENCES prix.fournisseurs(id) NOT NULL

**Prix :**
- `prix_ht` : REAL NOT NULL (prix hors taxes en FCFA)

**R√©gime fiscal :**
- `regime_fiscal` : TEXT NOT NULL DEFAULT 'tva_18'
  - Valeurs : "tva_18" | "sans_tva" | "brs_5"
  - "tva_18" : TVA 18% (fournisseurs formels)
  - "sans_tva" : Pas de TVA (boutiques informelles)
  - "brs_5" : BRS 5% (retenue √† la source)

**Prix calcul√©s (stock√©s pour performance) :**
- `prix_ttc` : REAL (= prix_ht √ó 1.18 si TVA, = prix_ht si sans TVA, NULL si BRS)
- `prix_brs` : REAL (= prix_ht / 0.95 si BRS, NULL sinon)

**Fournisseur par d√©faut :**
- `est_fournisseur_defaut` : BOOLEAN NOT NULL DEFAULT false
  - Contrainte : 1 seul fournisseur par d√©faut par produit (logique m√©tier)
  - Si 1er fournisseur ajout√© ‚Üí automatiquement par d√©faut

**M√©tadonn√©es :**
- `actif` : BOOLEAN NOT NULL DEFAULT true
- `date_creation` : TIMESTAMP NOT NULL DEFAULT NOW()
- `date_modification` : TIMESTAMP NOT NULL DEFAULT NOW()
- `cree_par` : TEXT (username)

**Index :**
- Index sur `produit_master_id`, `fournisseur_id`
- Index sur `est_fournisseur_defaut`
- UNIQUE sur (produit_master_id, fournisseur_id) pour √©viter doublons

#### Table : historique_prix (NOUVELLE)
Historique de toutes les modifications de prix.

Colonnes :
- `id` : SERIAL PRIMARY KEY
- `prix_fournisseur_id` : INTEGER REFERENCES prix.prix_fournisseurs(id) NOT NULL
- `prix_ht_ancien` : REAL
- `prix_ht_nouveau` : REAL NOT NULL
- `regime_fiscal_ancien` : TEXT
- `regime_fiscal_nouveau` : TEXT NOT NULL
- `modifie_par` : TEXT (username)
- `date_modification` : TIMESTAMP NOT NULL DEFAULT NOW()
- `raison` : TEXT (optionnel, ex: "N√©gociation fournisseur")

**Trigger PostgreSQL** : √Ä cr√©er pour alimenter automatiquement lors d'un UPDATE sur prix_fournisseurs

### 3. Extension PostgreSQL requise
Activer l'extension `pg_trgm` pour la recherche intelligente :
```sql
CREATE EXTENSION IF NOT EXISTS pg_trgm;
```

## üß† D√âTECTION INTELLIGENTE DES DOUBLONS

### Niveau 1 : Normalisation
Fonction utilitaire `normaliserNom(nom: string): string`

Transformations :
1. Convertir en minuscules
2. Supprimer accents (√© ‚Üí e, √† ‚Üí a)
3. Supprimer ponctuation (- . , : ; ! ?)
4. Supprimer espaces multiples ‚Üí espace unique
5. Trier les mots alphab√©tiquement
6. Trim()

Exemples :
- "Tuyau PVC PN10 DN63" ‚Üí "50 dn63 pn10 pvc tuyau"
- "TUYAU PVC √ò50" ‚Üí "50 pvc tuyau"
- "Canalisation PVC DN50" ‚Üí "50 canalisation dn pvc"

### Niveau 3 : R√®gles m√©tier
Fonction `rechercherProduitsSimilaires(nom: string, categorie: string): produit[]`

√âtapes :
1. Normaliser le nom saisi
2. Chercher dans `produits_master` de la m√™me cat√©gorie avec :
   - Trigrams PostgreSQL : `similarity(nom_normalise, :nom) > 0.7`
   - Ordre par score de similarit√© DESC
   - Limite 5 r√©sultats

Requ√™te SQL exemple :
```sql
SELECT *, similarity(nom_normalise, 'tuyau pvc 50mm') AS score
FROM referentiel.produits_master
WHERE categorie = :categorie
  AND actif = true
  AND similarity(nom_normalise, 'tuyau pvc 50mm') > 0.7
ORDER BY score DESC
LIMIT 5;
```

### Workflow cr√©ation produit
1. User remplit le formulaire (nom, cat√©gorie, unit√©)
2. En temps r√©el (au blur du champ "nom") : appeler `rechercherProduitsSimilaires`
3. Si r√©sultats > 0 : afficher un bandeau d'alerte
4. User peut choisir :
   - "Utiliser un produit existant" (annule la cr√©ation)
   - "Cr√©er quand m√™me" (continue avec doublon accept√©)

## üí∞ LOGIQUE M√âTIER PRIX/FOURNISSEURS

### Fonction : Calcul automatique prix
Fonction `calculerPrix(prixHt: number, regimeFiscal: string)`

```typescript
function calculerPrix(prixHt: number, regimeFiscal: string) {
  switch (regimeFiscal) {
    case "tva_18":
      return {
        prixHt,
        prixTtc: Math.round(prixHt * 1.18),
        prixBrs: null,
      };
    
    case "sans_tva":
      return {
        prixHt,
        prixTtc: prixHt,
        prixBrs: null,
      };
    
    case "brs_5":
      return {
        prixHt,
        prixTtc: null,
        prixBrs: Math.round(prixHt / 0.95),
      };
    
    default:
      throw new Error(`R√©gime fiscal inconnu: ${regimeFiscal}`);
  }
}
```

√Ä appliquer automatiquement lors de la cr√©ation/modification d'un prix.

### Fonction : Gestion fournisseur par d√©faut
Fonction `definirFournisseurParDefaut(produitId: number, prixFournisseurId: number)`

Logique :
1. Retirer le flag `est_fournisseur_defaut` de tous les prix de ce produit
2. D√©finir `est_fournisseur_defaut = true` pour le prix s√©lectionn√©

```typescript
async function definirFournisseurParDefaut(produitId: number, prixFournisseurId: number) {
  // 1. Retirer des autres
  await db
    .update(prixFournisseurs)
    .set({ estFournisseurDefaut: false })
    .where(eq(prixFournisseurs.produitMasterId, produitId));
  
  // 2. D√©finir le nouveau
  await db
    .update(prixFournisseurs)
    .set({ 
      estFournisseurDefaut: true,
      dateModification: new Date(),
    })
    .where(eq(prixFournisseurs.id, prixFournisseurId));
}
```

### Fonction : Ajout prix fournisseur
Fonction `ajouterPrixFournisseur(data)`

Logique sp√©ciale :
1. Si c'est le 1er fournisseur pour ce produit ‚Üí automatiquement par d√©faut
2. Calculer prix_ttc/prix_brs selon regime_fiscal
3. Cr√©er l'entr√©e dans `prix_fournisseurs`

```typescript
async function ajouterPrixFournisseur(data: {
  produitMasterId: number;
  fournisseurId: number;
  prixHt: number;
  regimeFiscal: string;
  estFournisseurDefaut?: boolean;
}) {
  // 1. Compter fournisseurs existants
  const nbFournisseurs = await db
    .select({ count: count() })
    .from(prixFournisseurs)
    .where(
      and(
        eq(prixFournisseurs.produitMasterId, data.produitMasterId),
        eq(prixFournisseurs.actif, true)
      )
    );
  
  // 2. 1er fournisseur = par d√©faut automatiquement
  const estDefaut = nbFournisseurs.count === 0 ? true : (data.estFournisseurDefaut || false);
  
  // 3. Si nouveau par d√©faut ‚Üí retirer des autres
  if (estDefaut) {
    await definirFournisseurParDefaut(data.produitMasterId, -1); // Reset tous
  }
  
  // 4. Calculer prix
  const { prixTtc, prixBrs } = calculerPrix(data.prixHt, data.regimeFiscal);
  
  // 5. Ins√©rer
  const [nouveauPrix] = await db.insert(prixFournisseurs).values({
    produitMasterId: data.produitMasterId,
    fournisseurId: data.fournisseurId,
    prixHt: data.prixHt,
    regimeFiscal: data.regimeFiscal,
    prixTtc,
    prixBrs,
    estFournisseurDefaut: estDefaut,
    actif: true,
  }).returning();
  
  return nouveauPrix;
}
```

### Trigger : Historique prix
Trigger PostgreSQL sur `UPDATE` de `prix_fournisseurs`

```sql
CREATE OR REPLACE FUNCTION enregistrer_historique_prix()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.prix_ht != NEW.prix_ht OR OLD.regime_fiscal != NEW.regime_fiscal THEN
    INSERT INTO prix.historique_prix (
      prix_fournisseur_id,
      prix_ht_ancien,
      prix_ht_nouveau,
      regime_fiscal_ancien,
      regime_fiscal_nouveau,
      date_modification
    ) VALUES (
      NEW.id,
      OLD.prix_ht,
      NEW.prix_ht,
      OLD.regime_fiscal,
      NEW.regime_fiscal,
      NOW()
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_historique_prix
AFTER UPDATE ON prix.prix_fournisseurs
FOR EACH ROW
EXECUTE FUNCTION enregistrer_historique_prix();
```

## üîÑ MIGRATION DES DONN√âES EXISTANTES

### √âtape 1 : Import depuis CSV Stock
Script de migration √† cr√©er dans `db/migrations/001_import_csv_stock.ts`

Process :
1. Lire le fichier CSV fourni (products.csv avec 200+ produits)
2. Pour chaque ligne :
   - Extraire : nom, categorie, sous_section, unite, longueur, largeur, couleur, est_template
   - Normaliser le nom ‚Üí `nom_normalise`
   - Ins√©rer dans `produits_master` avec :
     - `est_stockable = true` (tous les produits Stock sont stockables)
     - `source_app = "stock"`
     - `actif = true`
     - `cree_par = "migration_csv"`

3. Extraire les cat√©gories uniques ‚Üí ins√©rer dans `categories`
4. Extraire les unit√©s uniques ‚Üí ins√©rer dans `unites`

**Gestion des doublons** : Ignorer (SKIP) si `nom` existe d√©j√† (via UNIQUE constraint)

### √âtape 2 : Nettoyer les anciennes donn√©es Prix
Si des produits existent d√©j√† dans l'ancienne structure Prix :
- Les supprimer (donn√©es de test confirm√©es invalides par Michael)
- Garder uniquement la table `fournisseurs` si d√©j√† peupl√©e

## üé® INTERFACE UTILISATEUR

### Page : Liste produits
Fichier : `client/src/pages/ProduitsPage.tsx`

Affichage tableau :
- Colonnes : Nom, Cat√©gorie, Unit√©, Est stockable, Fournisseur d√©faut, Prix d√©faut, Actions
- Colonne "Prix d√©faut" : 
  - Si pas de fournisseur : "Prix non renseign√©" (texte gris)
  - Si fournisseur par d√©faut : "5 900 FCFA TTC (Fournisseur A)"
- Filtres : Cat√©gorie, Est stockable, Avec/sans prix

### Page : D√©tail produit
Fichier : `client/src/pages/ProduitDetailPage.tsx`

Structure :
1. **Section Informations produit**
   - Nom, cat√©gorie, unit√©, stockable, etc.
   - Bouton [Modifier]

2. **Section Fournisseurs et prix**
   - Liste des fournisseurs avec leurs prix
   - Design : Cards avec highlight pour le fournisseur par d√©faut (√©toile ‚≠ê)
   - Bouton [+ Ajouter un fournisseur]

Exemple card fournisseur :
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚≠ê Fournisseur A (par d√©faut)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Prix HT : 5 000 FCFA                        ‚îÇ
‚îÇ R√©gime : TVA 18%                            ‚îÇ
‚îÇ Prix TTC : 5 900 FCFA                       ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Derni√®re modification : 12/01/2026          ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ [Modifier] [Retirer par d√©faut] [Historique]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

Card fournisseur non-d√©faut :
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Fournisseur B                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Prix HT : 4 800 FCFA                        ‚îÇ
‚îÇ R√©gime : BRS 5%                             ‚îÇ
‚îÇ Prix BRS : 5 053 FCFA                       ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ [Modifier] [D√©finir par d√©faut] [Historique]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Composant : Formulaire cr√©ation produit
Fichier : `client/src/components/ProduitForm.tsx`

Champs :
- **Cat√©gorie** : Autocomplete/Select (liste depuis `categories`)
- **Nom** : Input texte avec recherche similarit√© en temps r√©el
- **Unit√©** : Select (liste depuis `unites`)
- **Est stockable** : Checkbox (d√©faut selon source_app)
- **Attributs optionnels** : Longueur, largeur, couleur (si cat√©gorie contient "G√©omembrane")

Validation :
- Nom obligatoire, unique
- Cat√©gorie et unit√© obligatoires

### Composant : Bandeau alerte doublons
Fichier : `client/src/components/ProduitSimilaireAlert.tsx`

Affichage si produits similaires d√©tect√©s (similarit√© > 70%) :
```
‚ö†Ô∏è Produits similaires trouv√©s :

üî∏ Tuyau PVC PN10 DN50 (Plomberie-Tuyauterie)
   Cr√©√© le 12/01/2026 | Stockable : Oui
   [Utiliser ce produit]

üî∏ Tube PVC diam√®tre 50 (Plomberie-Tuyauterie)
   Cr√©√© le 05/02/2026 | Stockable : Non
   [Utiliser ce produit]

[Aucun ne correspond, cr√©er nouveau produit]
```

Design : Utiliser shadcn/ui Alert avec variante "warning"

### Modal : Ajouter prix fournisseur
Fichier : `client/src/components/AjouterPrixModal.tsx`

Formulaire :
- **Fournisseur** : Select (liste depuis `fournisseurs`, actifs uniquement)
- **Prix HT** : Input number avec suffixe "FCFA"
- **R√©gime fiscal** : Radio buttons
  - ‚ö™ TVA 18% (d√©faut)
  - ‚ö™ Sans TVA (informel)
  - ‚ö™ BRS 5% (retenue √† la source)
- **Prix calcul√©** : Affichage dynamique (readonly) selon r√©gime
  - Si TVA : "Prix TTC : 5 900 FCFA"
  - Si Sans TVA : "Prix TTC : 5 000 FCFA"
  - Si BRS : "Prix BRS : 5 263 FCFA"
- **D√©finir par d√©faut** : Checkbox (d√©sactiv√©e si d√©j√† 1 fournisseur par d√©faut)

Validation :
- V√©rifier que ce fournisseur n'existe pas d√©j√† pour ce produit
- Prix HT > 0

### Modal : Historique prix
Fichier : `client/src/components/HistoriquePrixModal.tsx`

Affichage :
- Timeline des modifications (ordre chronologique inverse)
- Afficher : Date, Prix ancien ‚Üí Nouveau, R√©gime ancien ‚Üí Nouveau, Modifi√© par

Exemple :
```
üìÖ 20/02/2026 14:30
   Prix HT : 4 500 FCFA ‚Üí 5 000 FCFA
   R√©gime : TVA 18% (inchang√©)
   Modifi√© par : michael@filtreplante.com

üìÖ 15/01/2026 10:15
   Prix HT : 4 000 FCFA ‚Üí 4 500 FCFA
   R√©gime : Sans TVA ‚Üí TVA 18%
   Modifi√© par : admin@filtreplante.com
```

## üîå API REST (endpoints referentiel + prix)

### GET /api/referentiel/produits
Liste tous les produits.

Query params :
- `stockable` : boolean (filtre)
- `categorie` : string (filtre)
- `actif` : boolean (d√©faut true)
- `avec_prix` : boolean (inclure prix fournisseur par d√©faut)

Response :
```json
{
  "produits": [
    {
      "id": 1,
      "nom": "Tuyau PVC PN10 DN63",
      "categorie": "Plomberie-Tuyauterie",
      "unite": "m√®tre(s)",
      "est_stockable": true,
      "actif": true,
      "fournisseur_defaut": {
        "id": 5,
        "nom": "Fournisseur A",
        "prix_ht": 5000,
        "prix_ttc": 5900,
        "regime_fiscal": "tva_18"
      }
    }
  ]
}
```

### GET /api/referentiel/produits/:id
D√©tail produit avec tous ses fournisseurs.

Response :
```json
{
  "produit": {
    "id": 1,
    "nom": "Tuyau PVC PN10 DN63",
    "categorie": "Plomberie-Tuyauterie",
    "unite": "m√®tre(s)",
    "est_stockable": true,
    "prix_fournisseurs": [
      {
        "id": 10,
        "fournisseur": {
          "id": 5,
          "nom": "Fournisseur A"
        },
        "prix_ht": 5000,
        "prix_ttc": 5900,
        "regime_fiscal": "tva_18",
        "est_fournisseur_defaut": true,
        "date_modification": "2026-01-12T10:30:00Z"
      },
      {
        "id": 11,
        "fournisseur": {
          "id": 8,
          "nom": "Fournisseur B"
        },
        "prix_ht": 4800,
        "prix_brs": 5053,
        "regime_fiscal": "brs_5",
        "est_fournisseur_defaut": false,
        "date_modification": "2026-02-05T14:20:00Z"
      }
    ]
  }
}
```

### GET /api/referentiel/produits/search
Recherche intelligente avec d√©tection similarit√©.

Query params :
- `q` : string (nom √† rechercher)
- `categorie` : string (filtre optionnel)

Response :
```json
{
  "resultats": [
    {
      "id": 1,
      "nom": "Tuyau PVC PN10 DN63",
      "score": 0.95,
      "categorie": "Plomberie-Tuyauterie"
    }
  ]
}
```

### POST /api/referentiel/produits
Cr√©er un produit.

Body :
```json
{
  "nom": "Tuyau PVC PN10 DN63",
  "categorie": "Plomberie-Tuyauterie",
  "unite": "m√®tre(s)",
  "est_stockable": true,
  "longueur": null,
  "largeur": null,
  "couleur": null
}
```

Validation :
1. V√©rifier que `nom` n'existe pas d√©j√† (UNIQUE)
2. V√©rifier que `categorie` existe dans `categories`
3. V√©rifier que `unite` existe dans `unites`
4. Normaliser le nom ‚Üí `nom_normalise`

Response : 201 Created avec l'objet produit cr√©√©

### PATCH /api/referentiel/produits/:id/stockable
Passer un produit en stockable (utilis√© par Stock).

Body :
```json
{
  "est_stockable": true
}
```

Authorization : Scope `stock:write` requis

### POST /api/prix/produits/:id/fournisseurs
Ajouter un prix fournisseur √† un produit.

Body :
```json
{
  "fournisseur_id": 5,
  "prix_ht": 5000,
  "regime_fiscal": "tva_18",
  "est_fournisseur_defaut": false
}
```

Logique :
- Calculer automatiquement prix_ttc ou prix_brs
- Si 1er fournisseur ‚Üí par d√©faut automatiquement
- Si `est_fournisseur_defaut = true` ‚Üí retirer des autres

Response : 201 Created

### PATCH /api/prix/fournisseurs/:id
Modifier un prix fournisseur.

Body :
```json
{
  "prix_ht": 5200,
  "regime_fiscal": "tva_18"
}
```

Logique :
- Recalculer prix_ttc/prix_brs
- Enregistrer dans historique (via trigger PostgreSQL)

Response : 200 OK

### PATCH /api/prix/fournisseurs/:id/defaut
D√©finir comme fournisseur par d√©faut.

Body : vide

Logique :
- Retirer le flag des autres fournisseurs du m√™me produit
- D√©finir ce fournisseur en par d√©faut

Response : 200 OK

### GET /api/prix/fournisseurs/:id/historique
Historique prix d'un fournisseur.

Response :
```json
{
  "historique": [
    {
      "date_modification": "2026-02-20T14:30:00Z",
      "prix_ht_ancien": 4500,
      "prix_ht_nouveau": 5000,
      "regime_fiscal_ancien": "tva_18",
      "regime_fiscal_nouveau": "tva_18",
      "modifie_par": "michael@filtreplante.com"
    }
  ]
}
```

### GET /api/referentiel/categories
Liste des cat√©gories.

Response :
```json
{
  "categories": [
    { "id": 1, "nom": "Plomberie-Tuyauterie" },
    { "id": 2, "nom": "Outillage-Autres" }
  ]
}
```

### GET /api/referentiel/unites
Liste des unit√©s.

Response :
```json
{
  "unites": [
    { "code": "m", "libelle": "m√®tre(s)", "type": "longueur" },
    { "code": "u", "libelle": "unit√©(s)", "type": "quantit√©" }
  ]
}
```

## üîê AUTHENTIFICATION & SCOPES

### Syst√®me de scopes
Enrichir la gestion des cl√©s API existantes avec scopes.

Table : `api_keys` (√† enrichir si existe, sinon cr√©er)
- `id` : SERIAL PRIMARY KEY
- `key` : TEXT UNIQUE NOT NULL (cl√© g√©n√©r√©e)
- `nom` : TEXT (ex: "Cl√© Stock")
- `scopes` : TEXT[] (array de scopes PostgreSQL)
- `actif` : BOOLEAN DEFAULT true
- `date_creation` : TIMESTAMP DEFAULT NOW()
- `date_expiration` : TIMESTAMP (nullable)

Scopes d√©finis :
- `referentiel:read` : Lire produits/cat√©gories/unit√©s
- `referentiel:write` : Cr√©er/modifier produits
- `stock:read` : Lire donn√©es stock (futur)
- `stock:write` : Modifier donn√©es stock (futur)
- `prix:read` : Lire prix fournisseurs (tous users)
- `prix:read:admin` : Lire prix avec d√©tails co√ªts (admin uniquement)
- `prix:write` : Cr√©er/modifier prix

### Middleware validation scopes
Fichier : `server/middleware/checkScope.ts`

Fonction `requireScope(scope: string)` :
```typescript
export function requireScope(scope: string) {
  return async (req, res, next) => {
    const apiKey = req.headers['x-api-key'];
    
    if (!apiKey) {
      return res.status(401).json({ error: 'API key manquante' });
    }
    
    const keyData = await db
      .select()
      .from(apiKeys)
      .where(and(
        eq(apiKeys.key, apiKey),
        eq(apiKeys.actif, true)
      ))
      .limit(1);
    
    if (!keyData.length) {
      return res.status(401).json({ error: 'API key invalide' });
    }
    
    const { scopes } = keyData[0];
    if (!scopes.includes(scope)) {
      return res.status(403).json({ error: `Scope requis: ${scope}` });
    }
    
    req.apiKeyData = keyData[0];
    next();
  };
}
```

Exemple usage :
```typescript
app.get('/api/referentiel/produits', requireScope('referentiel:read'), async (req, res) => {
  // ...
});

app.post('/api/prix/produits/:id/fournisseurs', requireScope('prix:write'), async (req, res) => {
  // ...
});
```

### G√©n√©ration cl√©s API
Endpoint admin : `POST /api/admin/api-keys`

Body :
```json
{
  "nom": "Cl√© Stock",
  "scopes": ["referentiel:read", "referentiel:write", "stock:write"]
}
```

G√©n√©rer une cl√© al√©atoire s√©curis√©e (ex: avec `crypto.randomBytes`).

## üìÑ DOCUMENTATION

### README.md √† enrichir
Section √† ajouter :

```markdown
## R√©f√©rentiel Produits Filtreplante

Cette application h√©berge le r√©f√©rentiel centralis√© des produits Filtreplante avec gestion multi-fournisseurs.

### Schemas de base de donn√©es
- `referentiel` : Produits, cat√©gories, unit√©s (partag√© entre apps)
- `prix` : Fournisseurs et prix avec r√©gimes fiscaux (sp√©cifique)
- `stock` : Donn√©es de stock (app GestionStockFP)

### Apps connect√©es
- **GestionStockFP** : Lit/√©crit dans `referentiel`, g√®re le stock physique
- **Futures apps** : Calculateur devis, Maintenance, etc.

### R√®gles d'isolation
‚ö†Ô∏è **IMPORTANT** : Chaque app ne doit toucher QUE ses schemas + referentiel.
Ne JAMAIS modifier directement les schemas des autres apps.

### R√©gimes fiscaux S√©n√©gal
- **TVA 18%** : Fournisseurs formels (Prix TTC = HT √ó 1.18)
- **Sans TVA** : Boutiques informelles (Prix TTC = HT)
- **BRS 5%** : Retenue √† la source (Prix BRS = HT / 0.95)

### D√©tection doublons
Utilise PostgreSQL trigrams + normalisation intelligente pour d√©tecter les produits similaires (seuil 70%).

### API REST
Endpoints disponibles avec authentification par cl√© API + scopes :
- `/api/referentiel/*` : Gestion produits/cat√©gories/unit√©s
- `/api/prix/*` : Gestion prix fournisseurs
- Voir documentation compl√®te dans `/docs/api.md`
```

### Fichier : docs/api.md
Documentation compl√®te des endpoints API (format Markdown).

## ‚ö†Ô∏è POINTS D'ATTENTION

### Backward compatibility
- Toujours AJOUTER des colonnes (nullable)
- Jamais RENOMMER ni SUPPRIMER
- Si besoin de changer : cr√©er nouvelle colonne + migration progressive

### Performance
- Les index trigrams peuvent √™tre lents sur gros volumes (> 10k produits)
- Limiter la recherche similarit√© √† 5 r√©sultats max
- Index sur `produit_master_id` et `est_fournisseur_defaut` critiques

### Migrations coordonn√©es
Ce Repl h√©berge la base de donn√©es. Toute migration impacte potentiellement :
- GestionStockFP
- Futures apps

**Process** : Avant chaque migration Drizzle, v√©rifier l'impact sur les autres apps dans le canal Slack #dev-filtreplante.

### Contrainte fournisseur par d√©faut
Un seul fournisseur par d√©faut par produit. √Ä g√©rer via :
- Logique m√©tier (dans les fonctions ajout/modification)
- Possibilit√© d'ajouter constraint CHECK PostgreSQL (optionnel)

### Calculs prix
- Arrondir les prix TTC/BRS √† l'entier (FCFA)
- Toujours recalculer lors de la modification (pas de stockage incoh√©rent)

### Historique prix
- Trigger PostgreSQL enregistre automatiquement
- Pas de suppression d'historique (sauf GDPR)
- Utile pour audit et n√©gociations fournisseurs

## ‚úÖ CHECKLIST DE VALIDATION

Avant de consid√©rer cette t√¢che termin√©e, v√©rifier :

### Base de donn√©es
- [ ] Extension `pg_trgm` activ√©e
- [ ] Schemas `referentiel` et `prix` cr√©√©s
- [ ] Tables `produits_master`, `categories`, `unites` cr√©√©es avec index
- [ ] Table `prix_fournisseurs` cr√©√©e avec colonnes r√©gime fiscal
- [ ] Table `historique_prix` cr√©√©e
- [ ] Trigger historique prix fonctionnel
- [ ] Migration CSV Stock ex√©cut√©e (~200 produits import√©s)
- [ ] Cat√©gories et unit√©s peupl√©es

### D√©tection intelligente
- [ ] Fonction `normaliserNom` test√©e avec exemples
- [ ] Recherche trigrams fonctionne (similarit√© > 70%)
- [ ] Bandeau alerte doublons s'affiche lors de la cr√©ation

### Logique m√©tier prix
- [ ] Calcul automatique TTC/BRS selon r√©gime fiscal
- [ ] 1er fournisseur = par d√©faut automatiquement
- [ ] D√©finir nouveau par d√©faut retire l'ancien
- [ ] Historique enregistr√© lors modification prix

### API REST
- [ ] Endpoints `GET /api/referentiel/produits` fonctionnel avec filtre `avec_prix`
- [ ] Endpoint `GET /api/referentiel/produits/:id` retourne tous fournisseurs
- [ ] Endpoint `POST /api/prix/produits/:id/fournisseurs` avec validation
- [ ] Endpoint `PATCH /api/prix/fournisseurs/:id/defaut` bascule le flag
- [ ] Endpoint `GET /api/prix/fournisseurs/:id/historique` retourne timeline
- [ ] Scopes API impl√©ment√©s et test√©s

### Interface utilisateur
- [ ] Page liste produits avec colonne "Prix d√©faut"
- [ ] Affichage "Prix non renseign√©" si pas de fournisseur
- [ ] Page d√©tail produit avec cards fournisseurs
- [ ] Highlight fournisseur par d√©faut (√©toile ‚≠ê)
- [ ] Modal ajout prix avec calcul dynamique TTC/BRS
- [ ] Boutons "D√©finir par d√©faut" / "Retirer par d√©faut"
- [ ] Modal historique prix avec timeline
- [ ] Formulaire cr√©ation produit avec d√©tection doublons

### Documentation
- [ ] README enrichi avec sections R√©f√©rentiel et R√©gimes fiscaux
- [ ] Fichier `docs/api.md` cr√©√© avec endpoints document√©s
- [ ] Commentaires dans le code sur r√®gles d'isolation

## üöÄ NEXT STEPS (apr√®s ce brief)

Une fois ce Brief 1 termin√© :
- **Brief 2** : Connecter GestionStockFP au r√©f√©rentiel
- **Brief 3** : Modal intelligent "Passer en stockable" dans Stock
- **Brief 4** : API pour Calculateur/Devis (lecture prix fournisseur d√©faut)