# BRIEF CORRECTIF : Prix - Historique et Tri

## ğŸ¯ MODIFICATIONS

### 1. RETIRER LE BOUTON "MODIFIER" POUR LES PRIX

**ProblÃ¨me actuel :** Il y a un bouton "Modifier" sur chaque carte fournisseur.

**Solution :** Supprimer ce bouton.

**Logique mÃ©tier :**
- On ne modifie JAMAIS un prix existant
- On ajoute toujours un NOUVEAU prix qui remplace l'ancien
- L'ancien prix reste dans l'historique (via trigger PostgreSQL)

**UI souhaitÃ©e :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ABC MatÃ©riaux â­                         â”‚
â”‚ TVA 18%                                 â”‚
â”‚ 20 000 FCFA HT                          â”‚
â”‚ 23 600 FCFA TTC                         â”‚
â”‚                                         â”‚
â”‚ [Historique]                            â”‚  â† Garder uniquement Historique
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Workflow :**
1. User clique "Ajouter" (bouton en haut Ã  droite)
2. Si le fournisseur existe dÃ©jÃ  â†’ Message : "Ce fournisseur a dÃ©jÃ  un prix. Un nouveau prix sera crÃ©Ã© et l'ancien restera dans l'historique."
3. Le nouveau prix crÃ©Ã© â†’ ancien prix dÃ©sactivÃ© automatiquement (`actif = false`)
4. Trigger PostgreSQL enregistre dans `historique_prix`

**Code Ã  modifier :**

Dans la route `POST /api/prix/produits/:id/fournisseurs` :
- Si fournisseur existe dÃ©jÃ  pour ce produit â†’ DÃ©sactiver l'ancien (`actif = false`)
- CrÃ©er le nouveau prix (`actif = true`)
- Le trigger enregistrera automatiquement la transition dans `historique_prix`

---

### 2. AJOUTER COLONNE "DERNIÃˆRE MISE Ã€ JOUR" DANS LE TABLEAU

**ProblÃ¨me actuel :** La colonne "CrÃ©Ã© par" affiche qui a crÃ©Ã©, mais pas quand a eu lieu la derniÃ¨re modification.

**Solution :** Ajouter une colonne "DerniÃ¨re mise Ã  jour" entre "Prix final" et "CrÃ©Ã© par".

**UI souhaitÃ©e :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Produit     â”‚ CatÃ©gorieâ”‚ UnitÃ©   â”‚ Fournisseur  â”‚ Prix HTâ”‚ Prix finalâ”‚ DerniÃ¨re MAJ    â”‚ CrÃ©Ã© par  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bouteille   â”‚ ClotÃ»re  â”‚ unitÃ©(s)â”‚ ABC MatÃ©riauxâ”‚ 20 000 â”‚ 23 600   â”‚ 20/02/2026 14:30â”‚ migration â”‚
â”‚             â”‚          â”‚         â”‚ TVA 18%      â”‚        â”‚ (TTC)    â”‚                  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DonnÃ©es Ã  afficher :**
- Source : `prix_fournisseurs.date_modification`
- Format : `dd/mm/yyyy hh:mm` (franÃ§ais)
- Si jamais modifiÃ© : afficher la date de crÃ©ation (`date_creation`)

**Backend :**
Dans la query GET /api/referentiel/produits (avec prix), inclure `date_modification` :
```typescript
.select({
  // ... autres champs
  prixDateModification: prixFournisseurs.dateModification,
})
```

---

### 3. TRI PAR COLONNES (TITRES CLIQUABLES)

**ProblÃ¨me actuel :** Le tableau ne peut pas Ãªtre triÃ©.

**Solution :** Rendre les titres des colonnes cliquables pour permettre le tri.

**Colonnes triables :**
- âœ… **Produit** : Tri alphabÃ©tique (A-Z / Z-A)
- âœ… **CatÃ©gorie** : Tri alphabÃ©tique
- âœ… **Prix HT** : Tri numÃ©rique (croissant / dÃ©croissant)
- âœ… **Prix final** : Tri numÃ©rique
- âœ… **DerniÃ¨re MAJ** : Tri chronologique (plus rÃ©cent / plus ancien)
- âœ… **CrÃ©Ã© par** : Tri alphabÃ©tique

**UI souhaitÃ©e :**

Titres avec icÃ´ne de tri :
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Produit â†•  CatÃ©gorie â†•  Prix HT â†•  DerniÃ¨re MAJ â†•  CrÃ©Ã© par â†• â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

AprÃ¨s clic (tri actif) :
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Produit â–²  CatÃ©gorie â†•  Prix HT â†•  DerniÃ¨re MAJ â†•  CrÃ©Ã© par â†• â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Comportement :**
1. Clic 1 : Tri ascendant (A-Z, 0-9, ancienâ†’rÃ©cent) â†’ IcÃ´ne â–²
2. Clic 2 : Tri descendant (Z-A, 9-0, rÃ©centâ†’ancien) â†’ IcÃ´ne â–¼
3. Clic 3 : Retour Ã  l'ordre par dÃ©faut â†’ IcÃ´ne â†•

**ImplÃ©mentation :**

Utiliser shadcn/ui Table avec tri intÃ©grÃ© ou implÃ©menter manuellement :

```typescript
const [sortConfig, setSortConfig] = useState<{
  key: string;
  direction: 'asc' | 'desc' | null;
}>({ key: '', direction: null });

const handleSort = (key: string) => {
  let direction: 'asc' | 'desc' | null = 'asc';
  
  if (sortConfig.key === key) {
    if (sortConfig.direction === 'asc') direction = 'desc';
    else if (sortConfig.direction === 'desc') direction = null;
  }
  
  setSortConfig({ key, direction });
};

const sortedProduits = useMemo(() => {
  if (!sortConfig.direction) return produits;
  
  return [...produits].sort((a, b) => {
    let aVal = a[sortConfig.key];
    let bVal = b[sortConfig.key];
    
    // Gestion dates
    if (sortConfig.key === 'dateModification') {
      aVal = new Date(aVal).getTime();
      bVal = new Date(bVal).getTime();
    }
    
    // Gestion prix
    if (sortConfig.key === 'prixHt' || sortConfig.key === 'prixFinal') {
      aVal = parseFloat(aVal) || 0;
      bVal = parseFloat(bVal) || 0;
    }
    
    if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
    return 0;
  });
}, [produits, sortConfig]);
```

**Composant titre de colonne :**
```tsx
<TableHead
  onClick={() => handleSort('nom')}
  className="cursor-pointer hover:bg-gray-50"
>
  <div className="flex items-center space-x-1">
    <span>Produit</span>
    {sortConfig.key === 'nom' ? (
      sortConfig.direction === 'asc' ? <ChevronUp size={16} /> : <ChevronDown size={16} />
    ) : (
      <ChevronsUpDown size={16} className="text-gray-400" />
    )}
  </div>
</TableHead>
```

**IcÃ´nes Lucide :**
- `ChevronsUpDown` : Ã‰tat neutre (â†•)
- `ChevronUp` : Tri ascendant (â–²)
- `ChevronDown` : Tri descendant (â–¼)

---

## âœ… CHECKLIST DE VALIDATION

**Modification prix :**
- [ ] Bouton "Modifier" retirÃ© des cartes fournisseur
- [ ] Bouton "Ajouter" crÃ©e un nouveau prix (dÃ©sactive l'ancien si doublon)
- [ ] L'ancien prix reste visible dans l'historique
- [ ] Trigger PostgreSQL enregistre la transition

**Colonne DerniÃ¨re MAJ :**
- [ ] Colonne "DerniÃ¨re mise Ã  jour" visible dans le tableau
- [ ] Affiche `date_modification` au format franÃ§ais
- [ ] Si jamais modifiÃ©, affiche `date_creation`

**Tri par colonnes :**
- [ ] Titres de colonnes cliquables (curseur pointer)
- [ ] IcÃ´nes de tri visibles (â†• â–² â–¼)
- [ ] Tri Produit A-Z / Z-A fonctionne
- [ ] Tri Prix HT croissant / dÃ©croissant fonctionne
- [ ] Tri DerniÃ¨re MAJ rÃ©cent / ancien fonctionne
- [ ] Clic 3x sur une colonne â†’ retour ordre par dÃ©faut

**Tests :**
- [ ] Trier par "Produit" : ordre alphabÃ©tique correct
- [ ] Trier par "Prix HT" : ordre numÃ©rique correct (pas alphabÃ©tique !)
- [ ] Trier par "DerniÃ¨re MAJ" : ordre chronologique correct
- [ ] Ajouter un nouveau prix pour un fournisseur existant â†’ ancien dÃ©sactivÃ©, historique OK

---

## ğŸ¨ DESIGN

**Titres cliquables :**
- Hover : fond gris clair (`hover:bg-gray-50`)
- Curseur : pointer
- IcÃ´nes : taille 16px, gris clair quand inactif, turquoise (#3AA6B9) quand actif

**Colonne DerniÃ¨re MAJ :**
- Police : mÃªme style que les autres colonnes
- Format date : `20/02/2026 14:30` (franÃ§ais)
- Largeur : ajuster pour que la date soit lisible (min-width: 150px)