# AUTHENTIFICATION UNIFI√âE - GESTIONSTOCKFP (DUPLICATION)

## CONTEXTE

Prix-Referentiel a d√©j√† impl√©ment√© l'authentification compl√®te. Tu dois maintenant :

1. **COPIER** les fichiers auth depuis Prix-Referentiel
2. **ADAPTER** les routes pour app Stock
3. **PARTAGER** les m√™mes secrets JWT
4. **NE PAS** recr√©er la table users (d√©j√† existe)
5. **NE PAS** r√©ex√©cuter init-users (d√©j√† fait)

---

## √âTAPE 1 : COPIER VARIABLES D'ENVIRONNEMENT

‚ö†Ô∏è **CRITIQUE** : Les secrets doivent √™tre **EXACTEMENT IDENTIQUES** √† Prix-Referentiel.

Dans Replit Secrets (GestionStockFP), AJOUTER :
JWT_SECRET=<copier valeur EXACTE depuis Prix-Referentiel>
PASSWORD_SECRET_KEY=<copier valeur EXACTE depuis Prix-Referentiel>

‚ö†Ô∏è Si diff√©rent ‚Üí auth cass√©e entre les 2 apps !

**Comment r√©cup√©rer les valeurs** :
1. Ouvrir Prix-Referentiel
2. Aller dans Secrets
3. Copier JWT_SECRET
4. Copier PASSWORD_SECRET_KEY
5. Coller dans Secrets de GestionStockFP

---

## √âTAPE 2 : INSTALLER D√âPENDANCES

```bash
npm install jsonwebtoken crypto-js cookie-parser
npm install --save-dev @types/jsonwebtoken @types/cookie-parser
√âTAPE 3 : COPIER FICHIERS BACKEND
Depuis Prix-Referentiel, COPIER ces fichiers SANS MODIFICATION :
Fichiers √† copier :
Prix-Referentiel/                       ‚Üí  GestionStockFP/
‚îú‚îÄ shared/schema-users.ts               ‚Üí  shared/schema-users.ts (COPIE EXACTE)
‚îú‚îÄ server/utils/password-crypto.ts      ‚Üí  server/utils/password-crypto.ts (COPIE EXACTE)
‚îú‚îÄ server/middleware/auth.ts            ‚Üí  server/middleware/auth.ts (COPIE EXACTE)
‚îú‚îÄ server/routes/auth.ts                ‚Üí  server/routes/auth.ts (COPIE EXACTE)
‚îî‚îÄ server/routes/users.ts               ‚Üí  server/routes/users.ts (COPIE EXACTE)
‚ö†Ô∏è Aucune modification dans ces fichiers, copie exacte.
√âTAPE 4 : INT√âGRATION BACKEND
File: server/index.ts (GestionStockFP)
4.1 Ajouter imports
En haut du fichier, AJOUTER :
import cookieParser from "cookie-parser";
import authRoutes from "./routes/auth";
import usersRoutes from "./routes/users";
import { requireAuth, requireApp } from "./middleware/auth";
4.2 Ajouter middleware cookieParser
Juste apr√®s app.use(express.json()), AJOUTER :
app.use(cookieParser());
4.3 Ajouter routes auth (AVANT routes prot√©g√©es)
// Routes publiques auth
app.use("/api/auth", authRoutes);

// Routes admin users
app.use("/api/users", usersRoutes);
4.4 Prot√©ger routes stock existantes
AVANT vos routes stock existantes, AJOUTER :
// Prot√©ger toutes routes stock
app.use("/api/stock/*", requireAuth);
app.use("/api/stock/*", requireApp('stock'));
4.5 Prot√©ger routes r√©f√©rentiel (si pr√©sentes)
Si vous avez des routes /api/referentiel/* dans Stock (produits partag√©s), prot√©ger avec :
// Produits r√©f√©rentiel accessibles par Stock
app.use("/api/referentiel/*", requireAuth);
// Pas de requireApp('prix') car Stock peut lire r√©f√©rentiel
4.6 Tra√ßabilit√© : Ajouter user.nom
Dans TOUTES vos routes de modification (POST/PATCH mouvements, produits, etc.), AJOUTER :
// Exemple : cr√©ation mouvement stock
app.post("/api/stock/mouvements", requireAuth, async (req, res) => {
  const userName = (req as any).user.nom; // ‚Üê AJOUTER
  
  await db.insert(mouvementsStock).values({
    ...data,
    creePar: userName, // ‚Üê AJOUTER
  });
});

// Exemple : modification
app.patch("/api/stock/produits/:id", requireAuth, async (req, res) => {
  const userName = (req as any).user.nom; // ‚Üê AJOUTER
  
  await db.update(produits).set({
    ...updateData,
    modifiePar: userName, // ‚Üê AJOUTER
    dateModification: new Date(),
  });
});
R√©p√©ter pour toutes routes qui cr√©ent/modifient des donn√©es.
√âTAPE 5 : COPIER FICHIERS FRONTEND
Depuis Prix-Referentiel, COPIER ces fichiers SANS MODIFICATION :
Fichiers √† copier :
Prix-Referentiel/                              ‚Üí  GestionStockFP/
‚îú‚îÄ client/src/contexts/AuthContext.tsx         ‚Üí  client/src/contexts/AuthContext.tsx (COPIE EXACTE)
‚îú‚îÄ client/src/components/ProtectedRoute.tsx    ‚Üí  client/src/components/ProtectedRoute.tsx (COPIE EXACTE)
‚îú‚îÄ client/src/pages/Login.tsx                  ‚Üí  client/src/pages/Login.tsx (COPIE EXACTE)
‚îî‚îÄ client/src/pages/Users.tsx                  ‚Üí  client/src/pages/Users.tsx (COPIE EXACTE)
‚ö†Ô∏è Aucune modification, copie exacte.
√âTAPE 6 : INT√âGRATION FRONTEND
File: client/src/App.tsx (GestionStockFP)
6.1 Ajouter imports
import { AuthProvider } from "@/contexts/AuthContext";
import Login from "@/pages/Login";
import ProtectedRoute from "@/components/ProtectedRoute";
import Users from "@/pages/Users";
6.2 Wrapper avec AuthProvider
MODIFIER votre App pour wrapper avec <AuthProvider> :
function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <AuthProvider> {/* ‚Üê AJOUTER */}
        <Switch>
          {/* Route publique login */}
          <Route path="/login" component={Login} />
          
          {/* Vos routes existantes ‚Üí Wrapper avec ProtectedRoute */}
          <ProtectedRoute path="/" component={VotrePageStockPrincipale} />
          <ProtectedRoute path="/mouvements" component={Mouvements} />
          <ProtectedRoute path="/produits" component={Produits} />
          {/* ... autres routes ... */}
          
          {/* Route admin users */}
          <ProtectedRoute path="/users" component={Users} adminOnly />
          
          {/* 404 */}
          <Route component={() => <div>404 Not Found</div>} />
        </Switch>
        <Toaster />
      </AuthProvider> {/* ‚Üê AJOUTER */}
    </QueryClientProvider>
  );
}
6.3 Remplacer Route par ProtectedRoute
Pour chaque route prot√©g√©e, remplacer :
AVANT :
<Route path="/mouvements" component={Mouvements} />
APR√àS :
<ProtectedRoute path="/mouvements" component={Mouvements} />
√âTAPE 7 : NAVIGATION (optionnel)
Si vous avez une Navbar/Sidebar, ajouter :
7.1 Lien vers Prix-Referentiel (conditionnel)
import { useAuth } from "@/contexts/AuthContext";

export function Sidebar() {
  const { user, canAccessApp, logout, isAdmin } = useAuth();
  
  return (
    <div>
      {/* Vos liens stock existants */}
      <Link href="/">Stock</Link>
      <Link href="/mouvements">Mouvements</Link>
      
      {/* Lien vers Prix si autoris√© */}
      {canAccessApp('prix') && (
        <a href="https://prix-referentiel.votre-url.replit.app" target="_blank">
          üìä Prix-R√©f√©rentiel
        </a>
      )}
      
      {/* Admin users */}
      {isAdmin && (
        <Link href="/users">üë• Utilisateurs</Link>
      )}
      
      {/* Logout */}
      <button onClick={logout}>D√©connexion</button>
    </div>
  );
}
7.2 Afficher nom user
import { useAuth } from "@/contexts/AuthContext";

export function Header() {
  const { user } = useAuth();
  
  return (
    <header>
      <span>Connect√© : <strong>{user?.nom}</strong></span>
      {user?.role === "admin" && <Badge>Admin</Badge>}
    </header>
  );
}
√âTAPE 8 : V√âRIFICATIONS CRITIQUES
‚ö†Ô∏è NE PAS FAIRE
‚ùå NE PAS cr√©er table referentiel.users (d√©j√† existe)
‚ùå NE PAS ex√©cuter script init-users.ts
‚ùå NE PAS modifier les fichiers copi√©s (schema-users, auth.ts, etc.)
‚ùå NE PAS utiliser requireApp('prix') sur routes stock
‚úÖ FAIRE
‚úÖ COPIER exactement JWT_SECRET et PASSWORD_SECRET_KEY
‚úÖ COPIER tous les fichiers sans modification
‚úÖ UTILISER requireApp('stock') sur routes stock
‚úÖ AJOUTER req.user.nom dans toutes modifications
‚úÖ WRAPPER routes avec <ProtectedRoute>
TESTS APR√àS IMPL√âMENTATION
Backend
 Serveur d√©marre sans erreur
 GET /api/auth/usernames ‚Üí Retourne 3 users (michael, fatou, marine) - pas cheikh car pas acc√®s Prix
 GET /api/stock/* sans auth ‚Üí 401
 GET /api/stock/* avec cookie auth Prix-Referentiel ‚Üí Fonctionne (cookie partag√©)
Frontend
 Page /login affiche dropdown avec 4 users (michael, fatou, marine, cheikh)
 Login michael ‚Üí Acc√®s app Stock ‚úÖ
 Login cheikh ‚Üí Acc√®s app Stock ‚úÖ
 Login fatou ‚Üí Acc√®s app Stock ‚úÖ (car Prix implique Stock)
 Logout ‚Üí Redirect /login
Permissions
 Admin (michael) voit lien "Utilisateurs" dans menu
 Users normaux ne voient PAS ce lien
 Page /users accessible uniquement par michael
 Cheikh peut cr√©er mouvements ‚Üí creePar = "Cheikh"
Inter-apps
 Login sur Prix-Referentiel ‚Üí Cookie valide aussi sur Stock
 Login sur Stock ‚Üí Cookie valide aussi sur Prix-Referentiel (pour ceux qui ont acc√®s)
 Logout sur une app ‚Üí D√©connect√© sur les 2 (cookie cleared)
DIFF√âRENCES vs PRIX-REFERENTIEL
La SEULE diff√©rence dans le code :
Prix-Referentiel utilise :
app.use("/api/referentiel/*", requireApp('prix'));
app.use("/api/prix/*", requireApp('prix'));
GestionStockFP utilise :
app.use("/api/stock/*", requireApp('stock'));
// Pas de requireApp('prix') car tous les users Stock n'ont pas forc√©ment Prix
Tout le reste est IDENTIQUE.
CHECKLIST FINALE
Avant de valider :
Backend :
 Secrets JWT copi√©s exactement
 D√©pendances install√©es
 5 fichiers backend copi√©s
 cookieParser ajout√© dans index.ts
 Routes auth ajout√©es
 Routes stock prot√©g√©es avec requireAuth + requireApp('stock')
 user.nom ajout√© dans routes modification
Frontend :
 4 fichiers frontend copi√©s
 AuthProvider wrapper dans App.tsx
 Routes wrapped avec ProtectedRoute
 Navigation mise √† jour (optionnel)
Tests :
 Tous tests backend passent
 Tous tests frontend passent
 Tests permissions OK
 Tests inter-apps OK
SUPPORT
Si probl√®mes :
V√©rifier secrets env identiques (JWT_SECRET, PASSWORD_SECRET_KEY)
V√©rifier table users existe (1 seule fois dans referentiel)
V√©rifier cookies envoy√©s (DevTools ‚Üí Application ‚Üí Cookies)
V√©rifier logs serveur (erreurs JWT, d√©cryptage)
Tester route auth isol√©e (GET /api/auth/usernames)