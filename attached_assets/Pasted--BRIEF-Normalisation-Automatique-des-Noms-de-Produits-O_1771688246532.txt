# BRIEF : Normalisation Automatique des Noms de Produits

## ğŸ¯ OBJECTIF

Transformer automatiquement tous les noms de produits en "Title Case" (PremiÃ¨re Lettre De Chaque Mot En Majuscule) pour garantir la cohÃ©rence des donnÃ©es dans le rÃ©fÃ©rentiel partagÃ©.

---

## ğŸ“ RÃˆGLE DE TRANSFORMATION

**Format cible : Title Case**
- PremiÃ¨re lettre de chaque mot en MAJUSCULE
- Reste des lettres en minuscule
- Les chiffres et symboles sont prÃ©servÃ©s

**Exemples :**

| Actuellement en base         | AprÃ¨s normalisation           |
|------------------------------|-------------------------------|
| PAIRE GANTS                  | Paire Gants                   |
| t-shirt                      | T-Shirt                       |
| BOITE DE LIAISON ETANCHE     | Boite De Liaison Etanche      |
| cable a05vvf 3 x 1.5mm       | Cable A05vvf 3 X 1.5mm        |
| CABLE H05VVF 3Ã—2,5mm         | Cable H05vvf 3Ã—2,5mm          |
| Coffret Ã©lectrique PM        | Coffret Ã‰lectrique Pm         |

---

## ğŸ› ï¸ IMPLÃ‰MENTATION

### Ã‰TAPE 1 : Fonction de normalisation

File: `server/utils/normalizeProductName.ts` (CRÃ‰ER)

```typescript
/**
 * Transforme un nom de produit en Title Case
 * PremiÃ¨re lettre de chaque mot en majuscule, reste en minuscule
 */
export function normalizeProductName(name: string): string {
  if (!name || typeof name !== 'string') return '';
  
  return name
    .toLowerCase() // Tout en minuscule d'abord
    .split(' ')    // SÃ©parer par espaces
    .map(word => {
      if (word.length === 0) return word;
      // PremiÃ¨re lettre en majuscule + reste en minuscule
      return word.charAt(0).toUpperCase() + word.slice(1);
    })
    .join(' ')     // Rejoindre avec espaces
    .trim();       // Enlever espaces dÃ©but/fin
}
Ã‰TAPE 2 : Script de migration (CRITIQUE)
File: scripts/normalize-existing-products.ts (CRÃ‰ER)
import { db } from "../server/db";
import { produitsMaster } from "../shared/schema";
import { eq } from "drizzle-orm";

/**
 * Normaliser un nom en Title Case
 */
function normalizeProductName(name: string): string {
  if (!name || typeof name !== 'string') return '';
  
  return name
    .toLowerCase()
    .split(' ')
    .map(word => word.length > 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word)
    .join(' ')
    .trim();
}

/**
 * Normaliser pour recherche (sans accents, minuscules)
 */
function normaliserNom(nom: string): string {
  return nom
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9\s]/g, '')
    .trim();
}

async function normalizeExistingProducts() {
  console.log('ğŸ”„ Normalisation des noms de produits existants...\n');
  
  try {
    // 1. RÃ©cupÃ©rer tous les produits actifs
    const produits = await db
      .select()
      .from(produitsMaster);
    
    console.log(`ğŸ“¦ ${produits.length} produits Ã  traiter\n`);
    
    let updated = 0;
    let unchanged = 0;
    let errors = 0;
    
    // 2. Pour chaque produit, normaliser le nom
    for (const produit of produits) {
      const nomActuel = produit.nom;
      const nomNormalise = normalizeProductName(nomActuel);
      
      // VÃ©rifier si le nom change
      if (nomActuel !== nomNormalise) {
        console.log(`âœï¸  "${nomActuel}" â†’ "${nomNormalise}"`);
        
        try {
          // Mettre Ã  jour
          await db
            .update(produitsMaster)
            .set({
              nom: nomNormalise,
              nomNormalise: normaliserNom(nomNormalise),
              dateModification: new Date(),
              modifiePar: 'Script normalisation',
            })
            .where(eq(produitsMaster.id, produit.id));
          
          updated++;
        } catch (error: any) {
          console.error(`âŒ Erreur pour "${nomActuel}":`, error.message);
          errors++;
        }
      } else {
        unchanged++;
      }
    }
    
    console.log('\nâœ… Migration terminÃ©e :');
    console.log(`   - ${updated} produits normalisÃ©s`);
    console.log(`   - ${unchanged} produits inchangÃ©s`);
    if (errors > 0) {
      console.log(`   - ${errors} erreurs`);
    }
    
  } catch (error: any) {
    console.error('âŒ Erreur lors de la migration:', error);
    throw error;
  }
}

// ExÃ©cuter
normalizeExistingProducts()
  .then(() => {
    console.log('\nâœ… Script terminÃ© avec succÃ¨s');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\nâŒ Script Ã©chouÃ©:', error);
    process.exit(1);
  });
ExÃ©cution :
npx tsx scripts/normalize-existing-products.ts
Sortie attendue :
ğŸ”„ Normalisation des noms de produits existants...

ğŸ“¦ 340 produits Ã  traiter

âœï¸  "PAIRE GANTS" â†’ "Paire Gants"
âœï¸  "t-shirt" â†’ "T-Shirt"
âœï¸  "BOITE DE LIAISON ETANCHE" â†’ "Boite De Liaison Etanche"
âœï¸  "cable a05vvf 3 x 1.5mm" â†’ "Cable A05vvf 3 X 1.5mm"
...

âœ… Migration terminÃ©e :
   - 287 produits normalisÃ©s
   - 53 produits inchangÃ©s
   - 0 erreurs

âœ… Script terminÃ© avec succÃ¨s
Ã‰TAPE 3 : Application automatique (nouvelles donnÃ©es)
File: server/routes/referentiel.ts (MODIFIER routes existantes)
Import de la fonction
En haut du fichier, AJOUTER :
import { normalizeProductName } from "../utils/normalizeProductName";
Route POST /api/referentiel/produits
MODIFIER pour normaliser avant insertion :
app.post("/api/referentiel/produits", requireAuth, requireApp('prix'), async (req, res) => {
  try {
    const { nom, categorie, unite, ... } = req.body;
    const userName = req.user.nom;
    
    // â† AJOUTER : Normaliser le nom AVANT insertion
    const nomNormalise = normalizeProductName(nom);
    const nomNormaliseSearch = normaliserNom(nomNormalise);
    
    // VÃ©rifier doublons avec nom normalisÃ©
    const existant = await db
      .select()
      .from(produitsMaster)
      .where(eq(produitsMaster.nom, nomNormalise))
      .limit(1);
    
    if (existant.length > 0) {
      return res.status(409).json({
        error: 'Un produit avec ce nom existe dÃ©jÃ ',
        produitExistant: existant[0],
      });
    }
    
    // InsÃ©rer avec nom normalisÃ©
    const [produit] = await db
      .insert(produitsMaster)
      .values({
        nom: nomNormalise,              // â† NOM NORMALISÃ‰
        nomNormalise: nomNormaliseSearch,
        categorie,
        unite,
        creePar: userName,
        modifiePar: userName,
        actif: true,
      })
      .returning();
    
    res.status(201).json(produit);
  } catch (error: any) {
    console.error("Erreur crÃ©ation produit:", error);
    res.status(500).json({ error: error.message });
  }
});
Route PATCH /api/referentiel/produits/:id
MODIFIER pour normaliser si nom modifiÃ© :
app.patch("/api/referentiel/produits/:id", requireAuth, requireApp('prix'), async (req, res) => {
  try {
    const { id } = req.params;
    const userName = req.user.nom;
    const updateData: any = { 
      modifiePar: userName,
      dateModification: new Date(),
    };
    
    // Si nom modifiÃ©, normaliser
    if (req.body.nom !== undefined) {
      updateData.nom = normalizeProductName(req.body.nom);           // â† NORMALISER
      updateData.nomNormalise = normaliserNom(updateData.nom);
    }
    
    // Copier autres champs modifiÃ©s
    if (req.body.categorie !== undefined) updateData.categorie = req.body.categorie;
    if (req.body.unite !== undefined) updateData.unite = req.body.unite;
    // ... autres champs ...
    
    const [updated] = await db
      .update(produitsMaster)
      .set(updateData)
      .where(eq(produitsMaster.id, parseInt(id)))
      .returning();
    
    if (!updated) {
      return res.status(404).json({ error: "Produit non trouvÃ©" });
    }
    
    res.json(updated);
  } catch (error: any) {
    console.error("Erreur modification produit:", error);
    res.status(500).json({ error: error.message });
  }
});
Ã‰TAPE 4 : AperÃ§u frontend (optionnel - amÃ©liore UX)
File: client/src/components/ProductForm.tsx (ou ton formulaire produit)
AJOUTER cette fonction et state :
import { useState, useEffect } from "react";

// Fonction helper frontend (mÃªme logique que backend)
function normalizeProductName(name: string): string {
  if (!name) return '';
  return name
    .toLowerCase()
    .split(' ')
    .map(word => word.length > 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word)
    .join(' ')
    .trim();
}

export function ProductForm() {
  const [nom, setNom] = useState('');
  const [nomPreview, setNomPreview] = useState('');
  
  // Calculer aperÃ§u normalisÃ©
  useEffect(() => {
    if (nom) {
      const normalized = normalizeProductName(nom);
      setNomPreview(normalized);
    } else {
      setNomPreview('');
    }
  }, [nom]);
  
  return (
    <div>
      <Label htmlFor="nom">Nom du produit</Label>
      <Input
        id="nom"
        value={nom}
        onChange={(e) => setNom(e.target.value)}
        placeholder="Ex: PAIRE GANTS"
      />
      
      {/* AperÃ§u normalisation */}
      {nomPreview && nomPreview !== nom && (
        <p className="text-sm text-gray-500 mt-1">
          Sera enregistrÃ© comme : 
          <span className="font-medium text-teal-600 ml-1">
            {nomPreview}
          </span>
        </p>
      )}
      
      {/* Reste du formulaire */}
    </div>
  );
}
RÃ©sultat visuel :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Nom du produit                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ PAIRE GANTS                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ Sera enregistrÃ© comme : Paire Gants    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
âœ… CHECKLIST DE VALIDATION
Backend
 Fonction normalizeProductName() crÃ©Ã©e dans server/utils/
 Script scripts/normalize-existing-products.ts crÃ©Ã©
 Script exÃ©cutÃ© avec succÃ¨s (voir logs des transformations)
 VÃ©rifier en DB : SELECT nom FROM referentiel.produits_master LIMIT 20
 Route POST normalise avant insertion
 Route PATCH normalise si nom modifiÃ©
 Import ajoutÃ© dans server/routes/referentiel.ts
Tests Manuels
 CrÃ©er produit "PAIRE GANTS" â†’ EnregistrÃ© "Paire Gants" âœ…
 CrÃ©er produit "t-shirt" â†’ EnregistrÃ© "T-Shirt" âœ…
 Modifier nom "CABLE" â†’ "cable neuf" â†’ EnregistrÃ© "Cable Neuf" âœ…
 Essayer crÃ©er "Paire Gants" alors que "paire gants" existe â†’ Doublon dÃ©tectÃ© âœ…
 Produit avec chiffres "CABLE 3 x 1.5mm" â†’ "Cable 3 X 1.5mm" âœ…
 Produit avec accents "BOÃTE Ã‰LECTRIQUE" â†’ "BoÃ®te Ã‰lectrique" âœ…
Frontend (optionnel)
 AperÃ§u normalisation affichÃ© en temps rÃ©el
 Message "Sera enregistrÃ© comme : X" visible
Base de donnÃ©es
 Tous produits existants normalisÃ©s (vÃ©rifier manuellement quelques lignes)
 Pas de doublons crÃ©Ã©s par la normalisation
 Colonnes modifiePar et dateModification mises Ã  jour
ğŸ“ ORDRE D'EXÃ‰CUTION RECOMMANDÃ‰
âœ… CrÃ©er fonction normalizeProductName() dans server/utils/
âœ… CrÃ©er script scripts/normalize-existing-products.ts
âœ… EXÃ‰CUTER le script pour normaliser base existante (~340 produits)
âœ… Modifier routes POST/PATCH pour utiliser la fonction
âœ… Tester avec nouveaux produits
âœ… (Optionnel) Ajouter aperÃ§u frontend
âš ï¸ Important : ExÃ©cuter le script de migration AVANT de modifier les routes (pour Ã©viter incohÃ©rences temporaires).
ğŸ¯ RÃ‰SULTAT ATTENDU
Avant (base actuelle) :
PAIRE GANTS
t-shirt
BOITE DE LIAISON ETANCHE
cable a05vvf 3 x 1.5mm
CABLE H05VVF 3Ã—2,5mm
Coffret Ã©lectrique PM
AprÃ¨s migration :
Paire Gants
T-Shirt
Boite De Liaison Etanche
Cable A05vvf 3 X 1.5mm
Cable H05vvf 3Ã—2,5mm
Coffret Ã‰lectrique Pm
Plus professionnel, plus cohÃ©rent, plus facile Ã  lire ! âœ¨
âš ï¸ NOTES IMPORTANTES
Pourquoi faire Ã§a ?
âœ… CohÃ©rence visuelle : Tous les produits ont le mÃªme format
âœ… Professionnalisme : Plus agrÃ©able pour les utilisateurs
âœ… Recherche facilitÃ©e : Moins de confusion avec majuscules/minuscules
âœ… PrÃ©vention doublons : "CABLE" vs "cable" vs "Cable" dÃ©tectÃ© comme mÃªme produit
Impact sur GestionStockFP
Stock utilise la mÃªme table referentiel.produits_master
Une fois la migration exÃ©cutÃ©e ici, Stock verra automatiquement les noms normalisÃ©s
Il faudra aussi mettre Ã  jour Stock pour normaliser lors de crÃ©ations futures
Gestion des acronymes
Pour l'instant, on garde simple : tout en Title Case.
"CABLE EPI" â†’ "Cable Epi" (pas "Cable EPI")
"BOITE PVC" â†’ "Boite Pvc" (pas "Boite PVC")
Si tu veux garder certains acronymes en majuscules (EPI, PVC, DN, PM), on peut amÃ©liorer la fonction plus tard.