# BRIEF : Normalisation Automatique des Noms de Produits

## üéØ OBJECTIF
Transformer automatiquement tous les noms de produits en "Title Case" (Premi√®re Lettre De Chaque Mot En Majuscule) pour garantir la coh√©rence des donn√©es.

## üìù R√àGLE DE TRANSFORMATION

**Format cible : Title Case**
- Premi√®re lettre de chaque mot en MAJUSCULE
- Reste des lettres en minuscule
- Les chiffres et symboles sont pr√©serv√©s

**Exemples :**

| Saisi par l'agent | Transform√© automatiquement |
|-------------------|----------------------------|
| PAIRE GANTS | Paire Gants |
| t-shirt | T-Shirt |
| BOITE DE LIAISON ETANCHE | Boite De Liaison Etanche |
| cable a05vvf 3 x 1.5mm | Cable A05vvf 3 X 1.5mm |
| CABLE H05VVF 3√ó2,5mm | Cable H05vvf 3√ó2,5mm |
| Coffret √©lectrique PM | Coffret √âlectrique Pm |

## üõ†Ô∏è IMPL√âMENTATION

### 1. Fonction de normalisation

Cr√©er `server/utils/normalizeProductName.ts` :

```typescript
/**
 * Transforme un nom de produit en Title Case
 * Premi√®re lettre de chaque mot en majuscule, reste en minuscule
 */
export function normalizeProductName(name: string): string {
  if (!name) return '';
  
  return name
    .toLowerCase() // Tout en minuscule d'abord
    .split(' ') // S√©parer par espaces
    .map(word => {
      if (word.length === 0) return word;
      
      // Premi√®re lettre en majuscule
      return word.charAt(0).toUpperCase() + word.slice(1);
    })
    .join(' ') // Rejoindre avec espaces
    .trim();
}
```

**Tests √† ajouter (optionnel mais recommand√©) :**
```typescript
// tests/normalizeProductName.test.ts
import { normalizeProductName } from '../server/utils/normalizeProductName';

describe('normalizeProductName', () => {
  it('transforme tout majuscule en Title Case', () => {
    expect(normalizeProductName('PAIRE GANTS')).toBe('Paire Gants');
  });
  
  it('transforme tout minuscule en Title Case', () => {
    expect(normalizeProductName('t-shirt')).toBe('T-Shirt');
  });
  
  it('pr√©serve les chiffres et symboles', () => {
    expect(normalizeProductName('CABLE A05VVF 3 x 1.5mm')).toBe('Cable A05vvf 3 X 1.5mm');
  });
  
  it('g√®re les accents', () => {
    expect(normalizeProductName('bo√Æte √©lectrique')).toBe('Bo√Æte √âlectrique');
  });
  
  it('g√®re les espaces multiples', () => {
    expect(normalizeProductName('PAIRE   GANTS')).toBe('Paire Gants');
  });
});
```

### 2. Appliquer lors de la cr√©ation de produit

#### Dans FP-Referentiel-Produit

**Route POST /api/referentiel/produits :**
```typescript
import { normalizeProductName } from '../utils/normalizeProductName';

app.post('/api/referentiel/produits', requireAuth, async (req, res) => {
  const { nom, categorie, unite, ... } = req.body;
  
  // Normaliser le nom AVANT insertion
  const nomNormalise = normalizeProductName(nom);
  const nomNormaliseSearch = normaliserNom(nomNormalise); // Pour recherche similarit√©
  
  // V√©rifier doublons avec nom normalis√©
  const existant = await db
    .select()
    .from(produitsMaster)
    .where(eq(produitsMaster.nom, nomNormalise))
    .limit(1);
  
  if (existant.length > 0) {
    return res.status(409).json({ 
      error: 'Un produit avec ce nom existe d√©j√†',
      produitExistant: existant[0],
    });
  }
  
  // Ins√©rer avec nom normalis√©
  const [produit] = await db.insert(produitsMaster).values({
    nom: nomNormalise, // ‚Üê NOM NORMALIS√â
    nomNormalise: nomNormaliseSearch,
    categorie,
    unite,
    creePar: req.user?.nom || 'Syst√®me',
    actif: true,
  }).returning();
  
  res.status(201).json(produit);
});
```

**Route PATCH /api/referentiel/produits/:id :**
```typescript
app.patch('/api/referentiel/produits/:id', requireAuth, async (req, res) => {
  const { id } = req.params;
  const updates = req.body;
  
  // Si le nom est modifi√©, le normaliser
  if (updates.nom) {
    updates.nom = normalizeProductName(updates.nom);
    updates.nomNormalise = normaliserNom(updates.nom);
  }
  
  const [produit] = await db
    .update(produitsMaster)
    .set({
      ...updates,
      dateModification: new Date(),
    })
    .where(eq(produitsMaster.id, parseInt(id)))
    .returning();
  
  res.json(produit);
});
```

#### Dans GestionStockFP (Stock)

**M√™me logique dans ProductService.createStockProduct() :**
```typescript
import { normalizeProductName } from '../utils/normalizeProductName';

static async createStockProduct(data: { nom: string; ... }, creePar: string) {
  // Normaliser le nom
  const nomNormalise = normalizeProductName(data.nom);
  
  // Chercher dans r√©f√©rentiel avec nom normalis√©
  let produitMaster = await db
    .select()
    .from(produitsMaster)
    .where(eq(produitsMaster.nom, nomNormalise))
    .limit(1);
  
  // Si n'existe pas, cr√©er avec nom normalis√©
  if (produitMaster.length === 0) {
    produitMaster = await db
      .insert(produitsMaster)
      .values({
        nom: nomNormalise, // ‚Üê NOM NORMALIS√â
        nomNormalise: this.normaliserNom(nomNormalise),
        categorie: data.categorie,
        // ... autres champs
      })
      .returning();
  }
  
  // ... reste du code
}
```

### 3. Normalisation c√¥t√© Frontend (UX am√©lior√©e)

**Optionnel mais recommand√© :** Afficher la transformation en temps r√©el dans le formulaire.

Dans le formulaire de cr√©ation produit :
```tsx
const [nomProduit, setNomProduit] = useState('');
const [nomNormalise, setNomNormalise] = useState('');

const handleNomChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  const value = e.target.value;
  setNomProduit(value);
  
  // Afficher aper√ßu normalis√©
  if (value) {
    const normalized = normalizeProductName(value);
    setNomNormalise(normalized);
  } else {
    setNomNormalise('');
  }
};

return (
  <div>
    <Label htmlFor="nom">Nom du produit</Label>
    <Input
      id="nom"
      value={nomProduit}
      onChange={handleNomChange}
      placeholder="Ex: PAIRE GANTS"
    />
    {nomNormalise && nomNormalise !== nomProduit && (
      <p className="text-sm text-gray-500 mt-1">
        Sera enregistr√© comme : <span className="font-medium">{nomNormalise}</span>
      </p>
    )}
  </div>
);
```

**Fonction helper frontend :**
```typescript
// client/src/utils/normalizeProductName.ts
export function normalizeProductName(name: string): string {
  if (!name) return '';
  
  return name
    .toLowerCase()
    .split(' ')
    .map(word => word.length > 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word)
    .join(' ')
    .trim();
}
```

### 4. Script de migration pour les produits existants

Cr√©er `scripts/normalize-existing-products.ts` :

```typescript
import { db } from '../server/db';
import { produitsMaster } from '../shared/schema';
import { normalizeProductName } from '../server/utils/normalizeProductName';
import { normaliserNom } from '../server/utils/normaliserNom'; // Fonction de recherche

async function normalizeExistingProducts() {
  console.log('üîÑ Normalisation des noms de produits existants...');
  
  try {
    // 1. R√©cup√©rer tous les produits
    const produits = await db.select().from(produitsMaster);
    
    console.log(`üì¶ ${produits.length} produits √† normaliser`);
    
    let updated = 0;
    let unchanged = 0;
    
    // 2. Pour chaque produit, normaliser le nom
    for (const produit of produits) {
      const nomActuel = produit.nom;
      const nomNormalise = normalizeProductName(nomActuel);
      
      // V√©rifier si le nom change
      if (nomActuel !== nomNormalise) {
        console.log(`  ‚úèÔ∏è  "${nomActuel}" ‚Üí "${nomNormalise}"`);
        
        // Mettre √† jour
        await db
          .update(produitsMaster)
          .set({
            nom: nomNormalise,
            nomNormalise: normaliserNom(nomNormalise),
            dateModification: new Date(),
          })
          .where(eq(produitsMaster.id, produit.id));
        
        updated++;
      } else {
        unchanged++;
      }
    }
    
    console.log('\n‚úÖ Migration termin√©e :');
    console.log(`  - ${updated} produits normalis√©s`);
    console.log(`  - ${unchanged} produits inchang√©s`);
    
  } catch (error) {
    console.error('‚ùå Erreur lors de la migration:', error);
    throw error;
  }
}

normalizeExistingProducts();
```

**Ex√©cuter le script :**
```bash
tsx scripts/normalize-existing-products.ts
```

**Exemple de sortie attendue :**
```
üîÑ Normalisation des noms de produits existants...
üì¶ 328 produits √† normaliser
  ‚úèÔ∏è  "PAIRE GANTS" ‚Üí "Paire Gants"
  ‚úèÔ∏è  "t-shirt" ‚Üí "T-Shirt"
  ‚úèÔ∏è  "BOITE DE LIAISON ETANCHE" ‚Üí "Boite De Liaison Etanche"
  ‚úèÔ∏è  "cable a05vvf 3 x 1.5mm" ‚Üí "Cable A05vvf 3 X 1.5mm"
  ...

‚úÖ Migration termin√©e :
  - 287 produits normalis√©s
  - 41 produits inchang√©s
```

---

## ‚ö†Ô∏è GESTION DES CAS SP√âCIAUX

### Acronymes (optionnel avanc√©)

Si tu veux garder certains acronymes en MAJUSCULES (ex: "EPI", "PM", "PVC"), enrichir la fonction :

```typescript
const ACRONYMES = ['EPI', 'PM', 'PVC', 'DN', 'PN'];

export function normalizeProductName(name: string): string {
  if (!name) return '';
  
  return name
    .toLowerCase()
    .split(' ')
    .map(word => {
      if (word.length === 0) return word;
      
      // V√©rifier si c'est un acronyme connu
      const upperWord = word.toUpperCase();
      if (ACRONYMES.includes(upperWord)) {
        return upperWord;
      }
      
      // Sinon Title Case normal
      return word.charAt(0).toUpperCase() + word.slice(1);
    })
    .join(' ')
    .trim();
}
```

**Avec cette version :**
- "PAIRE GANTS EPI" ‚Üí "Paire Gants EPI" (EPI reste en majuscules)
- "cable pvc dn63" ‚Üí "Cable PVC DN63"

**√Ä toi de d√©cider** si tu veux cette complexit√© ou garder simple.

---

## ‚úÖ CHECKLIST DE VALIDATION

**Fonction de normalisation :**
- [ ] `normalizeProductName()` cr√©√©e et test√©e
- [ ] G√®re majuscules : "PAIRE GANTS" ‚Üí "Paire Gants"
- [ ] G√®re minuscules : "t-shirt" ‚Üí "T-Shirt"
- [ ] Pr√©serve chiffres/symboles : "CABLE 3 x 1.5mm" ‚Üí "Cable 3 X 1.5mm"
- [ ] G√®re accents : "BO√éTE √âLECTRIQUE" ‚Üí "Bo√Æte √âlectrique"

**Application automatique :**
- [ ] POST /api/referentiel/produits normalise avant INSERT
- [ ] PATCH /api/referentiel/produits normalise si nom modifi√©
- [ ] ProductService.createStockProduct() normalise (dans Stock)
- [ ] D√©tection doublons fonctionne avec noms normalis√©s

**Frontend (optionnel) :**
- [ ] Formulaire affiche aper√ßu "Sera enregistr√© comme : X"
- [ ] Transformation visible en temps r√©el

**Migration BDD :**
- [ ] Script `normalize-existing-products.ts` cr√©√©
- [ ] Script ex√©cut√© avec succ√®s (log des changements)
- [ ] Tous les produits en BDD sont maintenant en Title Case
- [ ] V√©rifier en BDD : `SELECT nom FROM referentiel.produits_master LIMIT 20`

**Tests :**
- [ ] Cr√©er produit "PAIRE GANTS" ‚Üí Enregistr√© comme "Paire Gants"
- [ ] Cr√©er produit "t-shirt" ‚Üí Enregistr√© comme "T-Shirt"
- [ ] Modifier nom "CABLE" ‚Üí "cable neuf" ‚Üí Enregistr√© "Cable Neuf"
- [ ] Essayer de cr√©er "Paire Gants" alors que "paire gants" existe ‚Üí Doublon d√©tect√©

---

## üìù NOTES

### Ordre d'ex√©cution recommand√©

1. **Impl√©menter la fonction** `normalizeProductName()`
2. **L'appliquer dans les routes** (cr√©ation/modification)
3. **Tester avec quelques produits** (cr√©er "TEST PRODUIT" ‚Üí v√©rifier en BDD)
4. **Ex√©cuter la migration** sur les produits existants
5. **V√©rifier visuellement** dans l'UI que tout est coh√©rent

### Backward compatibility

La normalisation ne casse RIEN :
- Les IDs restent les m√™mes
- Les relations FK restent intactes
- Seul le champ `nom` change (cosm√©tique)
- La colonne `nom_normalise` (pour recherche) est recalcul√©e

### Si probl√®me lors de la migration

Rollback simple :
```sql
-- Restaurer depuis backup
COPY referentiel.produits_master FROM '/path/to/backup.csv';
```

### Performance

La normalisation est instantan√©e (< 1ms par produit).
Aucun impact sur les performances de l'app.

---

## üéØ R√âSULTAT ATTENDU

**Avant :**
```
PAIRE GANTS
t-shirt
BOITE DE LIAISON ETANCHE
cable a05vvf 3 x 1.5mm
CABLE H05VVF 3√ó2,5mm
```

**Apr√®s :**
```
Paire Gants
T-Shirt
Boite De Liaison Etanche
Cable A05vvf 3 X 1.5mm
Cable H05vvf 3√ó2,5mm
```

**Plus professionnel, plus coh√©rent, plus facile √† lire !** ‚ú®