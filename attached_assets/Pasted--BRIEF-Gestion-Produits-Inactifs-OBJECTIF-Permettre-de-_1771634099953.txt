
# BRIEF : Gestion Produits Inactifs

## ğŸ¯ OBJECTIF
Permettre de dÃ©sactiver des produits (crÃ©Ã©s par erreur) et les masquer par dÃ©faut, avec option pour les afficher.

## ğŸ“‹ RÃˆGLES MÃ‰TIER

### Produit inactif = masquÃ© par dÃ©faut
- âŒ N'apparaÃ®t PAS dans la liste produits (par dÃ©faut)
- âŒ N'apparaÃ®t PAS dans les rÃ©sultats de recherche
- âŒ N'apparaÃ®t PAS dans les sÃ©lecteurs (crÃ©ation prix, etc.)
- âŒ Ne peut PAS Ãªtre marquÃ© comme stockable (`est_stockable = false` forcÃ©)

### Affichage des inactifs (optionnel)
- âœ… Filtre "Afficher inactifs" dans la barre de recherche
- âœ… Quand activÃ© â†’ produits inactifs affichÃ©s en grisÃ© avec badge "Inactif"
- âœ… PossibilitÃ© de rÃ©activer un produit inactif

---

## ğŸ› ï¸ IMPLÃ‰MENTATION

### 1. Colonne `actif` (existe dÃ©jÃ  âœ…)

La colonne existe dÃ©jÃ  dans `referentiel.produits_master` :
```typescript
actif: boolean("actif").notNull().default(true)
```

Pas de modification schema nÃ©cessaire.

---

### 2. Backend : Filtrer par dÃ©faut

#### Modifier GET /api/referentiel/produits

```typescript
app.get("/api/referentiel/produits", authOrScope("referentiel:read"), async (req, res) => {
  const { includeInactifs } = req.query; // Query param optionnel
  
  let query = db
    .select()
    .from(produitsMaster)
    .orderBy(produitsMaster.nom);
  
  // Par dÃ©faut, exclure inactifs
  if (includeInactifs !== "true") {
    query = query.where(eq(produitsMaster.actif, true));
  }
  
  const produits = await query;
  res.json({ produits });
});
```

#### Nouvelle route : DÃ©sactiver produit

```typescript
app.patch("/api/referentiel/produits/:id/desactiver", authOrScope("referentiel:write"), async (req, res) => {
  const { id } = req.params;
  
  try {
    // DÃ©sactiver le produit
    const [produit] = await db
      .update(produitsMaster)
      .set({
        actif: false,
        estStockable: false, // Forcer non-stockable
        dateModification: new Date(),
      })
      .where(eq(produitsMaster.id, parseInt(id)))
      .returning();
    
    if (!produit) {
      return res.status(404).json({ error: "Produit introuvable" });
    }
    
    res.json({ message: "Produit dÃ©sactivÃ©", produit });
  } catch (error) {
    console.error("Erreur dÃ©sactivation:", error);
    res.status(500).json({ error: "Erreur serveur" });
  }
});
```

#### Nouvelle route : RÃ©activer produit

```typescript
app.patch("/api/referentiel/produits/:id/reactiver", authOrScope("referentiel:write"), async (req, res) => {
  const { id } = req.params;
  
  try {
    const [produit] = await db
      .update(produitsMaster)
      .set({
        actif: true,
        dateModification: new Date(),
        // estStockable reste Ã  false (manuel aprÃ¨s si besoin)
      })
      .where(eq(produitsMaster.id, parseInt(id)))
      .returning();
    
    if (!produit) {
      return res.status(404).json({ error: "Produit introuvable" });
    }
    
    res.json({ message: "Produit rÃ©activÃ©", produit });
  } catch (error) {
    console.error("Erreur rÃ©activation:", error);
    res.status(500).json({ error: "Erreur serveur" });
  }
});
```

---

### 3. Frontend : Filtre "Afficher inactifs"

#### Dans la page Produits & Prix

**Ajouter un toggle dans la barre de recherche :**

```tsx
const [includeInactifs, setIncludeInactifs] = useState(false);

// Query produits avec filtre
const { data: produits } = useQuery({
  queryKey: ['produits', includeInactifs],
  queryFn: async () => {
    const url = `/api/referentiel/produits${includeInactifs ? '?includeInactifs=true' : ''}`;
    const res = await fetch(url);
    return res.json();
  },
});

// UI
<div className="flex items-center justify-between mb-4">
  <div className="flex items-center space-x-4">
    {/* Barre de recherche existante */}
    <Input
      placeholder="Rechercher un produit..."
      value={search}
      onChange={(e) => setSearch(e.target.value)}
    />
    
    {/* NOUVEAU : Toggle inactifs */}
    <label className="flex items-center space-x-2 text-sm cursor-pointer">
      <Checkbox
        checked={includeInactifs}
        onCheckedChange={setIncludeInactifs}
      />
      <span className="text-gray-700">Afficher inactifs</span>
    </label>
  </div>
  
  <Button onClick={() => setModalOpen(true)}>
    Nouveau produit
  </Button>
</div>
```

---

### 4. Frontend : Affichage produits inactifs

**Dans la liste produits :**

```tsx
{produits.map((produit) => (
  <TableRow 
    key={produit.id}
    className={!produit.actif ? 'bg-gray-50 opacity-60' : ''}
  >
    <TableCell>
      <div className="flex items-center space-x-2">
        <span className={!produit.actif ? 'text-gray-500 line-through' : ''}>
          {produit.nom}
        </span>
        {!produit.actif && (
          <Badge variant="secondary" className="bg-gray-300 text-gray-700">
            Inactif
          </Badge>
        )}
      </div>
    </TableCell>
    <TableCell>{produit.categorie}</TableCell>
    <TableCell>
      {/* Actions */}
      {produit.actif ? (
        <Button
          variant="ghost"
          size="sm"
          onClick={() => handleDesactiver(produit.id)}
        >
          <XCircle className="w-4 h-4 text-red-600" />
          DÃ©sactiver
        </Button>
      ) : (
        <Button
          variant="ghost"
          size="sm"
          onClick={() => handleReactiver(produit.id)}
        >
          <CheckCircle className="w-4 h-4 text-green-600" />
          RÃ©activer
        </Button>
      )}
    </TableCell>
  </TableRow>
))}
```

---

### 5. Frontend : Actions dÃ©sactiver/rÃ©activer

```tsx
const desactiverMutation = useMutation({
  mutationFn: async (produitId: number) => {
    const res = await fetch(`/api/referentiel/produits/${produitId}/desactiver`, {
      method: 'PATCH',
      credentials: 'include',
    });
    if (!res.ok) throw new Error('Erreur dÃ©sactivation');
    return res.json();
  },
  onSuccess: () => {
    queryClient.invalidateQueries(['produits']);
    toast({ title: 'Produit dÃ©sactivÃ©' });
  },
  onError: () => {
    toast({ title: 'Erreur', variant: 'destructive' });
  },
});

const reactiverMutation = useMutation({
  mutationFn: async (produitId: number) => {
    const res = await fetch(`/api/referentiel/produits/${produitId}/reactiver`, {
      method: 'PATCH',
      credentials: 'include',
    });
    if (!res.ok) throw new Error('Erreur rÃ©activation');
    return res.json();
  },
  onSuccess: () => {
    queryClient.invalidateQueries(['produits']);
    toast({ title: 'Produit rÃ©activÃ©' });
  },
});

const handleDesactiver = (id: number) => {
  if (confirm('DÃ©sactiver ce produit ? Il sera masquÃ© par dÃ©faut.')) {
    desactiverMutation.mutate(id);
  }
};

const handleReactiver = (id: number) => {
  reactiverMutation.mutate(id);
};
```

---

### 6. Validation : EmpÃªcher stockable si inactif

**Dans POST /api/referentiel/produits :**

```typescript
app.post("/api/referentiel/produits", authOrScope("referentiel:write"), async (req, res) => {
  const { estStockable, ...data } = req.body;
  
  // Si produit crÃ©Ã© inactif â†’ forcer estStockable = false
  const stockable = data.actif === false ? false : estStockable;
  
  const [produit] = await db.insert(produitsMaster).values({
    ...data,
    estStockable: stockable,
    creePar: req.session?.userName || 'SystÃ¨me',
  }).returning();
  
  res.status(201).json(produit);
});
```

**Dans PATCH /api/referentiel/produits/:id :**

```typescript
app.patch("/api/referentiel/produits/:id", authOrScope("referentiel:write"), async (req, res) => {
  const { id } = req.params;
  const updates = req.body;
  
  // Si on dÃ©sactive â†’ forcer estStockable = false
  if (updates.actif === false) {
    updates.estStockable = false;
  }
  
  const [produit] = await db
    .update(produitsMaster)
    .set({
      ...updates,
      dateModification: new Date(),
    })
    .where(eq(produitsMaster.id, parseInt(id)))
    .returning();
  
  res.json(produit);
});
```

---

## ğŸ¨ DESIGN

### Produit actif (normal)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tuyau PVC DN63                           â”‚
â”‚ Plomberie-Tuyauterie                     â”‚
â”‚ [ğŸ‘ Voir] [âœï¸ Modifier] [âŒ DÃ©sactiver]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Produit inactif (grisÃ©, ligne barrÃ©e)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tuyau PVC DN63  [Badge: Inactif]        â”‚  â† GrisÃ©, ligne barrÃ©e
â”‚ Plomberie-Tuyauterie                     â”‚
â”‚ [ğŸ‘ Voir] [âœ… RÃ©activer]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Filtre dans barre de recherche
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ” Rechercher...] [â˜‘ Afficher inactifs] [+ Nouveau]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… CHECKLIST VALIDATION

**Backend :**
- [ ] GET /api/referentiel/produits filtre `actif=true` par dÃ©faut
- [ ] Query param `?includeInactifs=true` inclut les inactifs
- [ ] PATCH /desactiver met `actif=false` et `est_stockable=false`
- [ ] PATCH /reactiver met `actif=true` (stockable reste false)
- [ ] POST/PATCH empÃªchent `est_stockable=true` si `actif=false`

**Frontend :**
- [ ] Checkbox "Afficher inactifs" visible dans barre recherche
- [ ] Par dÃ©faut dÃ©cochÃ© (inactifs masquÃ©s)
- [ ] Produits inactifs affichÃ©s grisÃ©s avec badge "Inactif"
- [ ] Bouton "DÃ©sactiver" visible sur produits actifs
- [ ] Bouton "RÃ©activer" visible sur produits inactifs
- [ ] Confirmation avant dÃ©sactivation

**Tests :**
- [ ] CrÃ©er produit "Test DÃ©sactivation" â†’ apparaÃ®t dans liste
- [ ] Cliquer "DÃ©sactiver" â†’ disparaÃ®t de la liste
- [ ] Cocher "Afficher inactifs" â†’ rÃ©apparaÃ®t grisÃ© avec badge
- [ ] Cliquer "RÃ©activer" â†’ redevient normal
- [ ] VÃ©rifier en BDD : `SELECT actif, est_stockable FROM referentiel.produits_master WHERE nom = 'Test DÃ©sactivation'`

**Edge cases :**
- [ ] DÃ©sactiver produit avec prix existants â†’ OK (prix restent, juste produit masquÃ©)
- [ ] RÃ©activer produit â†’ prix redeviennent visibles
- [ ] Produit inactif ne peut PAS Ãªtre marquÃ© stockable (validation backend)

---

## ğŸ“ NOTES

### Cascade sur prix ?
**Non recommandÃ©.** Si un produit est dÃ©sactivÃ©, ses prix restent en base (historique).
Ils seront juste masquÃ©s car le produit parent est inactif.

### Soft delete
C'est exactement ce qu'on fait : `actif=false` au lieu de `DELETE`.
Les donnÃ©es restent pour historique/audit.

### RÃ©activation
Un admin peut rÃ©activer un produit dÃ©sactivÃ© par erreur.
Le flag `est_stockable` reste Ã  `false` par sÃ©curitÃ© (Ã  rÃ©activer manuellement si besoin).