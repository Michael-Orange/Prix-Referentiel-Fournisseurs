# BRIEF CORRECTIF : Modifications Produits & Filtres

## üéØ PROBL√àMES √Ä CORRIGER

### 1. PERMETTRE DE MODIFIER LE STATUT "STOCKABLE"

**Probl√®me actuel :** Impossible de changer si un produit est stockable ou non apr√®s cr√©ation.

**Solution √† impl√©menter :**

Dans la page d√©tail produit (panneau lat√©ral ou page `/produits/:id`), ajouter une **checkbox "Stockable"** dans la section informations produit.

**UI souhait√©e :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Informations produit                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Nom : Bouteille diluant             ‚îÇ
‚îÇ Cat√©gorie : Clot√ªre                 ‚îÇ
‚îÇ Unit√© : unit√©(s)                    ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ ‚òë Produit stockable                 ‚îÇ  ‚Üê CHECKBOX interactive
‚îÇ                                     ‚îÇ
‚îÇ Source : stock                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Comportement :**
- Checkbox coch√©e = `est_stockable = true`
- Checkbox d√©coch√©e = `est_stockable = false`
- Changement imm√©diat lors du clic (pas besoin de bouton "Enregistrer")
- Toast de confirmation : "‚úì Statut stockable mis √† jour"

**Endpoint API √† utiliser (d√©j√† cr√©√©) :**
```
PATCH /api/referentiel/produits/:id/stockable
Body: { "est_stockable": true/false }
```

---

### 2. PERMETTRE DE MODIFIER UN PRIX FOURNISSEUR EXISTANT

**Probl√®me actuel :** 
- Message d'erreur "Ce fournisseur a d√©j√† un prix pour ce produit" quand on essaie d'ajouter un nouveau prix
- Pas de moyen de modifier un prix existant

**Solution √† impl√©menter :**

#### A) Ajouter un bouton "Modifier le prix" sur chaque card fournisseur

Dans la card fournisseur (ex: ABC Mat√©riaux), ajouter un bouton **"Modifier"** √† c√¥t√© de "Historique".

**UI actuelle :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ABC Mat√©riaux ‚≠ê                     ‚îÇ
‚îÇ TVA 18%                             ‚îÇ
‚îÇ 10 000 FCFA HT                      ‚îÇ
‚îÇ 11 800 FCFA TTC                     ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ [Historique]                        ‚îÇ  ‚Üê Ajouter [Modifier] ici
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**UI souhait√©e :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ABC Mat√©riaux ‚≠ê                     ‚îÇ
‚îÇ TVA 18%                             ‚îÇ
‚îÇ 10 000 FCFA HT                      ‚îÇ
‚îÇ 11 800 FCFA TTC                     ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ [Modifier] [Historique]             ‚îÇ  ‚Üê Bouton Modifier ajout√©
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### B) Modal de modification prix

Le bouton "Modifier" ouvre un modal similaire √† "Ajouter un prix" mais :
- Titre : "Modifier le prix - [Nom fournisseur]"
- Champs pr√©-remplis avec les valeurs actuelles
- Le fournisseur n'est PAS modifiable (readonly/disabled)
- On peut changer : Prix HT, R√©gime fiscal

**Formulaire :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Modifier le prix - ABC Mat√©riaux        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Fournisseur: ABC Mat√©riaux (non modif.) ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Prix HT (FCFA) *                        ‚îÇ
‚îÇ [12000________]                         ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ R√©gime fiscal *                         ‚îÇ
‚îÇ ‚ö™ TVA 18%                               ‚îÇ
‚îÇ ‚ö™ Sans TVA                              ‚îÇ
‚îÇ ‚ö™ BRS 5%                                ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Prix calcul√©:                           ‚îÇ
‚îÇ Prix HT: 12000 FCFA                     ‚îÇ
‚îÇ Prix TTC: 14160 FCFA                    ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Annuler]  [Enregistrer les modifications]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Endpoint API √† utiliser (d√©j√† cr√©√©) :**
```
PATCH /api/prix/fournisseurs/:id
Body: { 
  "prix_ht": 12000, 
  "regime_fiscal": "tva_18" 
}
```

**Effet attendu :**
- Le prix est mis √† jour
- L'historique enregistre automatiquement l'ancien et le nouveau prix (via trigger PostgreSQL)
- Toast de confirmation : "‚úì Prix mis √† jour"

#### C) Am√©liorer la validation lors de l'ajout

Actuellement, erreur "Ce fournisseur a d√©j√† un prix" est bloquante.

**Comportement souhait√© :**
- Si on essaie d'ajouter un fournisseur qui existe d√©j√† ‚Üí afficher un message plus clair :
  ```
  ‚ö†Ô∏è Ce fournisseur a d√©j√† un prix pour ce produit.
  Voulez-vous mettre √† jour le prix existant ?
  
  [Annuler] [Oui, mettre √† jour]
  ```
- Si l'utilisateur clique "Oui, mettre √† jour" ‚Üí transformer le modal "Ajouter" en "Modifier"

---

### 3. AJOUTER FILTRE "STOCKABLE" DANS LA BARRE DE RECHERCHE

**Probl√®me actuel :** Pas de filtre pour voir uniquement les produits stockables ou non-stockables.

**Solution √† impl√©menter :**

Dans la page "Produits & Prix", enrichir la barre de filtres existante.

**UI actuelle :**
```
[Rechercher un produit...] [Toutes cat√©gories ‚ñº] [Tous ‚ñº]
```

**UI souhait√©e :**
```
[Rechercher un produit...] [Toutes cat√©gories ‚ñº] [Tous ‚ñº] [Statut stockage ‚ñº]
                                                              ‚îî‚îÄ Tous
                                                              ‚îî‚îÄ Stockable
                                                              ‚îî‚îÄ Non stockable
```

**Comportement :**
- Par d√©faut : "Tous" (affiche tout)
- Si "Stockable" : filtre `est_stockable = true`
- Si "Non stockable" : filtre `est_stockable = false`

**Endpoint API :**
L'endpoint `GET /api/referentiel/produits` existe d√©j√† avec le param√®tre `stockable=true/false`.

Utiliser :
- `GET /api/referentiel/produits` ‚Üí Tous
- `GET /api/referentiel/produits?stockable=true` ‚Üí Stockables uniquement
- `GET /api/referentiel/produits?stockable=false` ‚Üí Non-stockables uniquement

---

## üé® DESIGN

- **Checkbox "Stockable"** : Utiliser le composant shadcn/ui Checkbox avec la couleur turquoise #3AA6B9 quand coch√©e
- **Bouton "Modifier"** : Style secondaire (outline) pour le diff√©rencier de "Historique"
- **Toast notifications** : shadcn/ui Toast avec ic√¥ne de succ√®s ‚úì

---

## ‚úÖ CHECKLIST DE VALIDATION

Apr√®s ces modifications, v√©rifier :

**Statut stockable :**
- [ ] La checkbox "Stockable" est visible dans le d√©tail produit
- [ ] Cliquer sur la checkbox change imm√©diatement le statut
- [ ] Toast de confirmation s'affiche
- [ ] Le badge "Stockable" dans la liste produits se met √† jour

**Modification prix :**
- [ ] Le bouton "Modifier" appara√Æt sur chaque card fournisseur
- [ ] Cliquer ouvre le modal avec valeurs pr√©-remplies
- [ ] Modifier le prix HT recalcule automatiquement TTC/BRS
- [ ] Enregistrer met √† jour le prix et cr√©e une entr√©e historique
- [ ] L'historique affiche bien l'ancien et le nouveau prix

**Filtre stockage :**
- [ ] Le filtre "Statut stockage" est visible dans la barre
- [ ] S√©lectionner "Stockable" affiche uniquement les produits stockables
- [ ] S√©lectionner "Non stockable" affiche uniquement les non-stockables
- [ ] Le filtre fonctionne en combinaison avec les autres filtres (cat√©gorie, recherche)

---

## üìù NOTES TECHNIQUES

### Gestion de l'unicit√© fournisseur
La contrainte UNIQUE `(produit_master_id, fournisseur_id)` emp√™che les doublons.

Pour la modification :
- Utiliser `PATCH /api/prix/fournisseurs/:id` (met √† jour l'entr√©e existante)
- Ne PAS essayer de recr√©er avec INSERT (=> erreur UNIQUE)

### Historique automatique
Le trigger PostgreSQL `trigger_historique_prix` enregistre automatiquement lors d'un UPDATE.
Pas besoin de code suppl√©mentaire pour l'historique.

### Performance filtre
Le filtre stockable utilise un index existant sur `est_stockable`.
Pas d'impact performance.